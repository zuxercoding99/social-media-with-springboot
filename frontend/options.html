<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <link rel="shortcut icon" href="icons/favicon.png" type="image/png" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Opciones - Red Social</title>

    <style>
      body.theme-loading header,
      body.theme-loading .sidebar::before {
        opacity: 0;
      }

      :root {
        --user-color: #1fe1d2;
        --user-color-dark: #3076e0;

        /* light */
        --bg-main: #ffffff;
        --bg-card: #ffffff;
        --text-main: #0f1419;
        --text-soft: #657786;
        --border-soft: #eff3f4;
        --border: #ccd6dd;
        --hover-soft: #f5f8fa;
      }
      body[data-theme="dark"] {
        --bg-main: #0f1419;
        --bg-card: #1d1f23;
        --text-main: #e7e9ea;
        --text-soft: #8b98a5;
        --border-soft: #2f3336;
        --border: #2f3336;
        --hover-soft: #202327;
      }

      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        color: var(--text-main);
        background: var(--bg-main);
        line-height: 1.4;
      }

      header {
        background: linear-gradient(
          135deg,
          var(--user-color),
          var(--user-color-dark)
        );
        color: white;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 1500;
      }
      .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: bold;
        font-size: 18px;
      }
      .header-more-btn {
        width: 18px;
        height: 18px;
        cursor: pointer;
        filter: invert(1);
        opacity: 0.95;
      }
      .header-more-btn:hover {
        transform: scale(1.05);
        opacity: 0.8;
        transition: 0.12s;
      }
      a.header-title {
        color: white;
        text-decoration: none;
        font-weight: bold;
      }

      /* sidebar (same structure used en otras páginas) */
      #sidebarBackdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.18);
        display: none;
        z-index: 1200;
      }
      .sidebar-icon {
        filter: none;
      }
      body[data-theme="dark"] .sidebar-icon {
        filter: invert(1) brightness(0.95);
      }
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100%;
        width: 220px;
        max-width: 80%;
        background: var(--bg-card);
        box-shadow: 2px 0 12px rgba(0, 0, 0, 0.12);
        z-index: 1300;
        transform: translateX(-100%);
        transition: transform 0.22s ease;
        display: flex;
        flex-direction: column;
        padding: 12px;
        /* dejar overflow hidden en el contenedor principal para evitar 'double scroll' */
        overflow: hidden;
      }
      .sidebar::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        height: 120px;
        width: 100%;
        background: linear-gradient(
          135deg,
          var(--user-color),
          var(--user-color-dark)
        );
        z-index: -1;
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .sidebar-user {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 14px;
        padding-top: 40px;
        padding-bottom: 24px;

        flex: 0 0 auto;
      }
      .sidebar-user img {
        width: 96px;
        height: 96px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
      }
      .displayname {
        font-weight: bold;
        font-size: 20px;
        color: var(--text-main);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .username-small {
        font-size: 16px;
        color: var(--text-soft);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* la nav ocupa el resto y puede scrollear */
      .sidebar-nav {
        flex: 1 1 auto; /* ocupa el resto del alto disponible */
        overflow-y: auto; /* aquí activamos scroll cuando haga falta */
        padding-right: 6px; /* para que no choque con scrollbar */
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      /* suaviza scroll en iOS */
      .sidebar-nav {
        -webkit-overflow-scrolling: touch;
      }

      /* opcional: estilos para scrollbar */
      .sidebar-nav::-webkit-scrollbar {
        width: 10px;
      }
      .sidebar-nav::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.12);
        border-radius: 10px;
      }
      .sidebar-nav a {
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--text-main);
        text-decoration: none;
        padding: 12px 16px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
      }
      .sidebar-nav a:hover {
        background: var(--hover-soft);
      }

      /*
      .sidebar-nav a.active {
        color: var(--user-color);
      }
      */

      /* main */
      .page {
        max-width: 960px;
        margin: 14px auto;
        padding: 0 12px;
      }
      .panel {
        max-width: 720px;
        margin: 16px auto;
        background: var(--bg-card);
        border: 1px solid var(--border-soft);
        border-radius: 12px;
        padding: 18px;
      }

      h1 {
        margin: 0 0 12px 0;
        font-size: 18px;
        color: var(--text-main);
      }
      .theme-row {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .theme-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--bg-card);
        color: var(--text-main);
        cursor: pointer;
        font-weight: 700;
        user-select: none;
      }
      .theme-btn .dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }
      .theme-btn.light .dot {
        background: #fff;
        border: 1px solid #ddd;
      }
      .theme-btn.dark .dot {
        background: #111;
        border: 1px solid rgba(255, 255, 255, 0.06);
      }
      .theme-btn.active {
        border-color: var(--user-color);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      }

      .save-row {
        margin-top: 14px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }
      .save-btn {
        padding: 10px 14px;
        border-radius: 10px;
        border: none;
        background: linear-gradient(
          135deg,
          var(--user-color),
          var(--user-color-dark)
        );
        color: white;
        font-weight: 700;
        cursor: pointer;
      }
      .status {
        margin-top: 10px;
        color: var(--text-soft);
        font-size: 14px;
      }

      @media (max-width: 480px) {
        .theme-row {
          flex-direction: column;
        }
        .save-row {
          justify-content: stretch;
        }
      }
    </style>
  </head>

  <body>
    <header>
      <div class="header-left">
        <img
          id="headerMoreBtn"
          src="icons/more.png"
          alt="menu"
          class="header-more-btn"
        />
        <a href="feed.html" class="header-title">RED SOCIAL</a>
      </div>
    </header>

    <div id="sidebarBackdrop"></div>

    <aside id="sidebar" class="sidebar" aria-hidden="true">
      <div class="sidebar-user">
        <img
          id="sidebarAvatar"
          src="icons/upload.png"
          alt="me"
          title="Ver perfil"
        />
        <div class="displayname" id="sidebarDisplayName">Usuario</div>
        <div class="username-small" id="sidebarUsername">@usuario</div>
      </div>

      <nav class="sidebar-nav">
        <a href="feed.html"
          ><img src="icons/home.png" class="sidebar-icon" alt="" /> Home</a
        >
        <a href="requests.html"
          ><img src="icons/add-friend.png" class="sidebar-icon" alt="" />
          Solicitudes</a
        >
        <a href="chat.html"
          ><img src="icons/email.png" class="sidebar-icon" alt="" /> Chat</a
        >
        <a href="user.html"
          ><img src="icons/user.png" class="sidebar-icon" alt="" /> Profile</a
        >
        <a href="options.html" class="active"
          ><img src="icons/settings.png" class="sidebar-icon" alt="" />
          Opciones</a
        >
        <a href="#" id="sidebarLogout"
          ><img src="icons/exit.png" class="sidebar-icon" alt="" /> Log out</a
        >
      </nav>
    </aside>

    <main class="page">
      <section class="panel" aria-labelledby="title">
        <h1 id="title">Tema</h1>

        <div class="theme-row" id="themeRow">
          <button
            id="btnLight"
            class="theme-btn light"
            type="button"
            aria-pressed="false"
          >
            <span class="dot" aria-hidden="true"></span>
            Light
          </button>

          <button
            id="btnDark"
            class="theme-btn dark"
            type="button"
            aria-pressed="false"
          >
            <span class="dot" aria-hidden="true"></span>
            Dark
          </button>
        </div>

        <div class="save-row">
          <button id="saveBtn" class="save-btn" type="button">Guardar</button>
        </div>

        <div id="status" class="status" role="status" aria-live="polite"></div>
      </section>
    </main>

    <script src="config.js"></script>

    <script>
      document.body.classList.add("theme-loading");
      const API = CONFIG.API_BASE_URL;
      const token = localStorage.getItem("accessToken");
      const username = localStorage.getItem("username");
      const displayName = localStorage.getItem("displayName");
      const avatarUrl = localStorage.getItem("avatarUrl");

      // Sidebar wiring (same behavior as other pages)
      const headerMoreBtn = document.getElementById("headerMoreBtn");
      const sidebar = document.getElementById("sidebar");
      const sidebarBackdrop = document.getElementById("sidebarBackdrop");
      const sidebarAvatar = document.getElementById("sidebarAvatar");
      const sidebarDisplayName = document.getElementById("sidebarDisplayName");
      const sidebarUsernameEl = document.getElementById("sidebarUsername");
      const sidebarLogout = document.getElementById("sidebarLogout");

      function openSidebar() {
        sidebar.classList.add("open");
        sidebarBackdrop.style.display = "block";
        sidebar.setAttribute("aria-hidden", "false");
      }
      function closeSidebar() {
        sidebar.classList.remove("open");
        sidebarBackdrop.style.display = "none";
        sidebar.setAttribute("aria-hidden", "true");
      }

      headerMoreBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        sidebar.classList.contains("open") ? closeSidebar() : openSidebar();
      });
      sidebarBackdrop.addEventListener("click", closeSidebar);

      sidebarDisplayName.innerText = displayName || username || "Usuario";
      sidebarUsernameEl.innerText = "@" + (username || "usuario");
      if (avatarUrl) {
        (async () => {
          try {
            const r = await fetch(API + avatarUrl, {
              headers: { Authorization: "Bearer " + token },
            });
            if (r.ok) {
              const b = await r.blob();
              sidebarAvatar.src = URL.createObjectURL(b);
            } else sidebarAvatar.src = "https://via.placeholder.com/64";
          } catch {
            sidebarAvatar.src = "https://via.placeholder.com/64";
          }
        })();
      } else sidebarAvatar.src = "https://via.placeholder.com/64";

      sidebarAvatar.addEventListener("click", () => {
        if (username) location.href = `user.html?username=${username}`;
      });
      sidebarDisplayName.addEventListener("click", () => {
        if (username) location.href = `user.html?username=${username}`;
      });
      sidebarUsernameEl.addEventListener("click", () => {
        if (username) location.href = `user.html?username=${username}`;
      });

      sidebarLogout.addEventListener("click", () => {
        localStorage.clear();
        location.href = "login.html";
      });

      // Theme controls
      const btnLight = document.getElementById("btnLight");
      const btnDark = document.getElementById("btnDark");
      const saveBtn = document.getElementById("saveBtn");
      const statusEl = document.getElementById("status");

      function applyTheme(mode) {
        if (mode === "DARK") document.body.setAttribute("data-theme", "dark");
        else document.body.setAttribute("data-theme", "light");
        // visual active
        if (mode === "DARK") {
          btnDark.classList.add("active");
          btnDark.setAttribute("aria-pressed", "true");
          btnLight.classList.remove("active");
          btnLight.setAttribute("aria-pressed", "false");
        } else {
          btnLight.classList.add("active");
          btnLight.setAttribute("aria-pressed", "true");
          btnDark.classList.remove("active");
          btnDark.setAttribute("aria-pressed", "false");
        }
      }

      // read local preference and apply; default LIGHT
      const localMode =
        localStorage.getItem("mode").toLocaleUpperCase() === "DARK"
          ? "DARK"
          : localStorage.getItem("mode").toLocaleUpperCase() === "LIGHT"
          ? "LIGHT"
          : null;
      if (localMode) applyTheme(localMode);
      else applyTheme("LIGHT");

      // choose (client-side only until save)
      let chosen = localMode || "LIGHT";
      btnLight.addEventListener("click", () => {
        chosen = "LIGHT";
        applyTheme("LIGHT");
        statusEl.textContent = "";
      });
      btnDark.addEventListener("click", () => {
        chosen = "DARK";
        applyTheme("DARK");
        statusEl.textContent = "";
      });

      async function saveThemeToServer(mode) {
        const body = { themeMode: mode };
        const res = await fetch(`${API}/api/v1/users/me/theme`, {
          method: "PATCH",
          headers: {
            Authorization: "Bearer " + token,
            "Content-Type": "application/json",
          },
          body: JSON.stringify(body),
        });
        return res;
      }

      saveBtn.addEventListener("click", async () => {
        statusEl.textContent = "";
        // If there's a token -> try server patch, store only on success
        if (token) {
          saveBtn.disabled = true;
          statusEl.textContent = "Guardando...";
          try {
            const r = await saveThemeToServer(chosen);
            if (r.ok) {
              localStorage.setItem("mode", chosen.toLocaleLowerCase());
              applyTheme(chosen);
              statusEl.style.color = ""; // rely on CSS var
              statusEl.textContent = "Guardado.";
            } else {
              const t = await r.text().catch(() => r.statusText);
              statusEl.style.color = "var(--text-soft)";
              statusEl.textContent = "Error: " + (t || `HTTP ${r.status}`);
            }
          } catch (e) {
            statusEl.style.color = "var(--text-soft)";
            statusEl.textContent = "Error de conexión.";
          } finally {
            saveBtn.disabled = false;
          }
        } else {
          // no token: just save locally and apply
          localStorage.setItem("mode", chosen.toLocaleLowerCase());
          applyTheme(chosen);
          statusEl.textContent = "Guardado localmente (no logueado).";
        }
      });

      async function fetchMyProfile() {
        const r = await fetch(`${API}/api/v1/users/me`, {
          headers: { Authorization: "Bearer " + token },
        });

        if (!r.ok) throw new Error("No se pudo cargar el perfil");

        return r.json();
      }

      async function initUserTheme() {
        try {
          const u = await fetchMyProfile();
          applyUserTheme(u.bannerColor);
        } catch (e) {
          console.warn("Usando tema por defecto", e);
          applyUserTheme(null);
        }
      }

      /*Color sidebar header banner*/
      function applyUserTheme(color) {
        const root = document.documentElement;

        if (color) {
          root.style.setProperty("--user-color", color);
          root.style.setProperty("--user-color-dark", darkenColor(color, 25));
        } else {
          root.style.setProperty("--user-color", "#1fe1d2");
          root.style.setProperty("--user-color-dark", "#3076e0");
        }
        document.body.classList.remove("theme-loading");
      }

      function darkenColor(hex, percent) {
        const num = parseInt(hex.replace("#", ""), 16);
        const amt = Math.round(2.55 * percent);
        const r = Math.max(0, (num >> 16) - amt);
        const g = Math.max(0, ((num >> 8) & 0x00ff) - amt);
        const b = Math.max(0, (num & 0x0000ff) - amt);

        return `rgb(${r}, ${g}, ${b})`;
      }

      initUserTheme();
    </script>
  </body>
</html>
