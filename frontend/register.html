<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="icons/favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Registro ¬∑ LionX</title>

    <style>
      /* ---------- RESET ---------- */
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Helvetica, Arial, sans-serif;
        background: radial-gradient(
            1000px 600px at 30% 15%,
            rgba(210, 170, 255, 0.3),
            transparent 65%
          ),
          linear-gradient(180deg, #4b00ab, #241b3a);
        color: #eef2f7;
        overflow-x: hidden;
      }

      /* ---------- LAYOUT ---------- */
      .page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 32px 20px;
      }

      .auth-card {
        width: 100%;
        max-width: 420px;
        padding: 48px 32px;
        display: flex;
        flex-direction: column;
        gap: 14px;
        animation: fadeIn 0.8s ease forwards;
      }

      /* ---------- HEADER ---------- */
      .auth-header {
        text-align: center;
        margin-bottom: 18px;
      }

      .auth-header img {
        height: 70px;
        margin-bottom: 8px;
        cursor: pointer;
      }

      .auth-header h2 {
        margin: 0;
        font-size: 28px;
        font-weight: 700;
      }

      .auth-header p {
        margin: 6px auto 0;
        font-size: 14px;
        color: #9aa3af;
        max-width: 280px;
      }

      /* ---------- FORM ---------- */
      label {
        font-size: 13px;
        color: #cbd5e1;
        margin-top: 6px;
      }

      input {
        width: 100%;
        height: 46px;
        padding: 0 14px;
        border-radius: 10px;
        border: 1px solid #263041;
        background: #e6e9ee;
        color: #0f1623;
        font-size: 15px;
      }

      input::placeholder {
        color: #7f8896;
      }

      input:focus {
        outline: none;
        border-color: #27ccff;
        box-shadow: 0 0 0 1px rgba(39, 204, 255, 0.4);
      }

      /* ---------- BUTTON ---------- */
      button {
        margin-top: 18px;
        height: 48px;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        background: linear-gradient(135deg, #27ccff, #1da1f2);
        color: #fff;
        transition: all 0.25s ease;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 24px rgba(39, 204, 255, 0.35);
      }

      /* ---------- MESSAGES ---------- */
      #msg {
        margin-top: 10px;
        font-size: 14px;
        text-align: center;
      }

      .error {
        color: #f87171;
      }

      .success {
        color: #34d399;
      }

      /* ---------- FOOTER ---------- */
      .switch {
        margin-top: 22px;
        font-size: 14px;
        text-align: center;
        color: #9aa3af;
      }

      .switch a {
        color: #27ccff;
        text-decoration: none;
        font-weight: 600;
      }

      .switch a:hover {
        text-decoration: underline;
      }

      /* ---------- ANIMATIONS ---------- */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>

  <body>
    <div class="page">
      <div class="auth-card">
        <div class="auth-header">
          <img src="icons/lion.png" alt="LionX" class="lion" />
          <h2>Crear cuenta</h2>
          <p>Unite a LionX y empez√° a compartir</p>
        </div>

        <label for="username">Username</label>
        <input id="username" placeholder="ej: bob94" />

        <label for="email">Email</label>
        <input id="email" placeholder="bob@example.com" />

        <label for="password">Password</label>
        <input id="password" type="password" placeholder="6 a 12 caracteres" />

        <label for="birthDate">Fecha de nacimiento</label>
        <input id="birthDate" type="date" />

        <button onclick="register()">Crear cuenta</button>

        <div id="msg"></div>

        <div class="switch">
          ¬øYa ten√©s cuenta?
          <a href="login.html">Iniciar sesi√≥n</a>
        </div>
      </div>
    </div>

    <script src="config.js"></script>

    <script>
      const API_BASE_URL = CONFIG.API_BASE_URL;

      if (localStorage.getItem("accessToken")) {
        window.location.href = "feed.html";
      }

      function calcularEdad(fechaNacimiento) {
        const hoy = new Date();
        const nacimiento = new Date(fechaNacimiento);
        let edad = hoy.getFullYear() - nacimiento.getFullYear();
        const m = hoy.getMonth() - nacimiento.getMonth();

        if (m < 0 || (m === 0 && hoy.getDate() < nacimiento.getDate())) {
          edad--;
        }

        return edad;
      }

      function validarFormulario() {
        // USERNAME
        if (!username.value.trim()) {
          return "El username es obligatorio";
        }

        if (username.value.length < 2 || username.value.length > 30) {
          return "El username debe tener entre 2 y 30 caracteres";
        }

        if (!/^[A-Za-z0-9_]+$/.test(username.value)) {
          return "El username solo puede contener letras, n√∫meros y guiones bajos";
        }

        // EMAIL
        if (!email.value.trim()) {
          return "El email es obligatorio";
        }

        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) {
          return "El email debe tener un formato v√°lido";
        }

        // PASSWORD
        if (!password.value) {
          return "La contrase√±a es obligatoria";
        }

        if (password.value.length < 6 || password.value.length > 12) {
          return "La contrase√±a debe tener entre 6 y 12 caracteres";
        }

        // BIRTH DATE
        if (!birthDate.value) {
          return "La fecha de nacimiento es obligatoria";
        }

        const edad = calcularEdad(birthDate.value);

        if (edad < 13) {
          return "La edad m√≠nima es 13 a√±os";
        }

        if (edad > 99) {
          return "La edad m√°xima es 99 a√±os";
        }

        return null; // ‚úî todo OK
      }

      async function register() {
        const msg = document.getElementById("msg");
        const button = document.querySelector("button");

        msg.innerText = "";
        msg.className = "";

        const error = validarFormulario();
        if (error) {
          msg.className = "error";
          msg.innerText = error;
          return;
        }

        // üîí Bloquear bot√≥n
        button.disabled = true;
        button.style.opacity = "0.7";
        button.style.cursor = "not-allowed";

        try {
          const res = await fetch(API_BASE_URL + "/api/v1/auth/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: username.value.trim(),
              email: email.value.trim(),
              password: password.value,
              birthDate: birthDate.value,
            }),
          });

          const data = await res.json().catch(() => null);

          if (res.ok) {
            msg.className = "success";
            msg.innerText =
              "Usuario registrado con √©xito. Ya pod√©s iniciar sesi√≥n.";
            return;
          }

          msg.className = "error";

          // ‚ö†Ô∏è 409 Conflict
          if (res.status === 409 && data?.detail) {
            msg.innerText = data.detail;
            return;
          }

          // ‚ö†Ô∏è 400 Bad Request con errores por campo
          if (res.status === 400 && data?.errors) {
            const errores = Object.values(data.errors);
            msg.innerText = errores.join("\n");
            return;
          }

          // ‚ö†Ô∏è Error gen√©rico
          msg.innerText = data?.detail || "Ocurri√≥ un error al crear la cuenta";
        } catch (err) {
          msg.className = "error";
          msg.innerText = "No se pudo conectar con el servidor";
        } finally {
          // üîì Rehabilitar bot√≥n
          button.disabled = false;
          button.style.opacity = "1";
          button.style.cursor = "pointer";
        }
      }

      document.querySelector(".lion").addEventListener("click", () => {
        window.location.href = "index.html";
      });
    </script>
  </body>
</html>
