<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="icons/favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Post - Red Social</title>
    <style>
      /* -----------------------
     THEME & COLOR VARIABLES
     ----------------------- */
      :root {
        --user-color: #1fe1d2;
        --user-color-dark: #3076e0;

        /* LIGHT (values equal to current light-mode look) */
        --bg-main: #ffffff; /* page background */
        --bg-soft: #f5f8fa; /* subtle backgrounds (chat, hover, etc) */
        --bg-card: #ffffff; /* cards / containers / tweets */

        --text-main: #0f1419; /* primary text */
        --text-soft: #657786; /* secondary / meta text */
        --muted: #8899a6;

        --border-soft: #eff3f4; /* soft borders */
        --border: #ccd6dd;

        --hover-soft: #f5f8fa; /* hover bg in light mode */

        --overlay-bg: rgba(255, 255, 255, 0.95); /* image overlay (light) */

        --bubble-bg: #e6e8eb; /* public chat bubble (light) */

        --link-color: #1d9bf0;

        --danger: #e0245e;
        --success: #17bf63;

        --post-disabled: #aab8c2;
      }

      /* DARK MODE OVERRIDES (activate with body[data-theme="dark"]) */
      body[data-theme="dark"] {
        --bg-main: #0f1419;
        --bg-soft: #16181c;
        --bg-card: #1d1f23;

        --text-main: #e7e9ea;
        --text-soft: #8b98a5;
        --muted: #8b98a5;

        --border-soft: #2f3336;
        --border: #2f3336;

        --hover-soft: #202327;

        --overlay-bg: rgba(0, 0, 0, 0.85);

        --bubble-bg: #252a2d;

        --link-color: #1d9bf0;

        --danger: #f9708d;
        --success: #3ddc84;

        --post-disabled: #3a4146;
      }

      /* -----------------------
     GENERAL
     ----------------------- */
      body.theme-loading header,
      body.theme-loading .sidebar::before {
        opacity: 0;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        line-height: 1.4;
        color: var(--text-main);
        margin: 0;
        background: var(--bg-main);
      }

      /* HEADER */
      header {
        background: linear-gradient(
          135deg,
          var(--user-color),
          var(--user-color-dark)
        );
        color: white;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        position: sticky;
        top: 0;
        z-index: 1500;
        transition: background 0.3s, opacity 0.3s;
      }
      header.scrolled {
        opacity: 0.62;
      }
      header a.header-title {
        color: white;
        text-decoration: none;
        font-weight: bold;
        cursor: pointer;
      }
      .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: bold;
        font-size: 18px;
      }
      .header-more-btn {
        width: 18px;
        height: 18px;
        cursor: pointer;
        filter: invert(1);
        opacity: 0.95;
      }
      .header-more-btn:hover {
        opacity: 0.8;
        transform: scale(1.05);
        transition: 0.12s;
      }

      /* invertir colores en dark mode */
      .no-filter {
        filter: none;
      }

      body[data-theme="dark"] .filter-dark-mode {
        filter: invert(1) brightness(0.95);
      }

      /* SIDEBAR */
      .sidebar-icon {
        filter: none;
      }
      body[data-theme="dark"] .sidebar-icon {
        filter: invert(1) brightness(0.95);
      }

      #sidebarBackdrop {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.18);
        display: none;
        z-index: 1200;
      }

      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100%;
        width: 220px;
        max-width: 80%;
        background: var(--bg-card);
        box-shadow: 2px 0 12px rgba(0, 0, 0, 0.12);
        z-index: 1300;
        transform: translateX(-100%);
        transition: transform 0.22s ease;
        display: flex;
        flex-direction: column;
        padding: 12px;
        /* dejar overflow hidden en el contenedor principal para evitar 'double scroll' */
        overflow: hidden;
      }

      .sidebar-nav a:hover {
        background: color-mix(in srgb, var(--user-color), var(--bg-card) 85%);
      }

      .sidebar-nav a.active {
        color: var(--user-color);
      }

      .sidebar::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        height: 120px;
        width: 100%;
        background: linear-gradient(
          135deg,
          var(--user-color),
          var(--user-color-dark)
        );
        z-index: -1;
      }

      .sidebar.open {
        transform: translateX(0);
      }
      .sidebar-user {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding-top: 40px;
        padding-bottom: 24px;

        flex: 0 0 auto; /* no se encoge ni crece */
      }
      .sidebar-user img {
        width: 96px;
        height: 96px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
      }
      .sidebar-user .displayname {
        font-weight: bold;
        color: var(--text-main);
        font-size: 20px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .sidebar-user .username-small {
        font-size: 16px;
        color: var(--text-soft);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      /* la nav ocupa el resto y puede scrollear */
      .sidebar-nav {
        flex: 1 1 auto; /* ocupa el resto del alto disponible */
        overflow-y: auto; /* aqu√≠ activamos scroll cuando haga falta */
        padding-right: 6px; /* para que no choque con scrollbar */
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      /* suaviza scroll en iOS */
      .sidebar-nav {
        -webkit-overflow-scrolling: touch;
      }

      /* opcional: estilos para scrollbar */
      .sidebar-nav::-webkit-scrollbar {
        width: 10px;
      }
      .sidebar-nav::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.12);
        border-radius: 10px;
      }
      .sidebar-nav a {
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--text-main);
        text-decoration: none;
        padding: 12px 16px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
      }
      .sidebar-nav a img {
        width: 24px;
        height: 24px;
        object-fit: cover;
      }
      .sidebar-nav a:hover {
        background: var(--hover-soft);
      }

      /* LAYOUT */
      .container {
        width: 100%;
        max-width: 618px;
        margin: 12px auto;
        padding: 0;
        background: var(--bg-card);
        border-left: 1px solid var(--border-soft);
        border-right: 1px solid var(--border-soft);
      }

      /* TWEET (unificado) */
      .tweet {
        margin: 0 auto;
        padding: 12px 16px 0;
        background: var(--bg-card);
        border-top: 1px solid var(--border-soft);
        border-radius: 0;
      }
      .tweet-layout {
        display: flex;
        align-items: flex-start;
        gap: 12px;
      }
      .tweet-avatar {
        width: 40px;
        flex-shrink: 0;
      }
      .tweet-avatar img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
      }
      .tweet-body {
        flex: 1;
        padding-bottom: 12px;
        min-width: 0;
      }
      .tweet-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
        gap: 8px;
      }
      .tweet-user {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        min-width: 0;
        font-size: 15px;
        gap: 8px;
      }
      .display-name {
        font-weight: bold;
        color: var(--text-main);
        cursor: pointer;
      }
      .username {
        font-size: 15px;
        color: var(--text-soft);
        cursor: pointer;
      }
      .post-time {
        font-size: 15px;
        color: var(--text-soft);
        white-space: nowrap;
      }
      .tweet-privacy-inline {
        font-size: 13px;
        color: var(--text-soft);
        white-space: nowrap;
        opacity: 0.85;
        margin-left: 6px;
      }
      .tweet-content {
        font-size: 15px;
        line-height: 1.45;
        word-wrap: break-word;
        white-space: pre-wrap;
        color: var(--text-main);
      }
      .tweet-image {
        margin-top: 12px;
        cursor: pointer;
        border-radius: 16px;
        overflow: hidden;
        max-width: 516px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        background: var(--bg-card);
      }
      .tweet-image img {
        max-width: 100%;
        max-height: 500px;
        border: 1px solid var(--border-soft);
        width: auto;
        height: auto;
        object-fit: contain;
        display: block;
        border-radius: 16px;
        overflow: hidden;
      }

      .more-btn {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
        cursor: pointer;
        opacity: 0.8;
      }
      .more-btn:hover {
        opacity: 1;
      }
      .options-menu {
        position: absolute;
        top: 28px;
        right: 0;
        background: var(--bg-card);
        border: 1px solid var(--border-soft);
        border-radius: 12px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        display: none;
        flex-direction: column;
        min-width: 160px;
        padding: 6px 0;
        z-index: 50;
      }
      .options-menu .option {
        padding: 10px 14px;
        display: flex;
        gap: 10px;
        align-items: center;
        cursor: pointer;
        font-size: 14px;
      }
      .options-menu .option:hover {
        background: var(--hover-soft);
      }
      .options-menu .delete-option {
        color: var(--danger);
      }

      .empty {
        text-align: center;
        color: var(--text-soft);
        margin: 30px 0;
      }

      /* COMMENTS */
      .comments {
        margin-top: 12px;
        padding: 12px;
        background: var(--bg-card);
        border-top: 1px solid var(--border-soft);
      }
      .comments .composer {
        padding: 8px 0;
        border-bottom: none;
        background: transparent;
      }
      .comment-item {
        display: flex;
        gap: 10px;
        padding: 12px 0;
        border-bottom: 1px solid var(--hover-soft);
        align-items: flex-start;
      }
      .comment-avatar img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
      }

      .comment-body .username {
        cursor: pointer;
        color: var(--text-main);
      }

      .comment-displayname {
        cursor: pointer;
        color: var(--text-main);
      }

      .comment-body {
        flex: 1;
        color: var(--text-main);
      }
      .comment-meta {
        display: flex;
        gap: 8px;
        align-items: center;
        font-size: 14px;
        color: var(--text-soft);
      }
      .comment-content {
        margin-top: 6px;
        font-size: 15px;
        line-height: 1.4;
        color: var(--text-main);
      }
      .comment-delete-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        color: var(--danger);
        font-weight: bold;
        padding: 6px;
      }

      /* COMMENT INPUT */
      .comment-input {
        width: 100%;
        border: 1px solid var(--border-soft);
        border-radius: 10px;
        padding: 8px 10px;
        min-height: 44px;
        resize: none;
        outline: none;
        font-size: 15px;
        background: var(--bg-card);
        color: var(--text-main);
      }
      .comment-row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-top: 8px;
        justify-content: space-between;
      }
      .comment-btn {
        background: var(--user-color);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
      }
      .comment-btn:disabled {
        background: var(--post-disabled);
        cursor: default;
      }

      /* IMAGE LIGHTBOX */
      .image-overlay {
        position: fixed;
        inset: 0;
        background: var(--overlay-bg);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        padding: 24px;
      }
      .image-overlay img {
        width: 80vw;
        height: 80vh;
        max-width: 900px;
        max-height: 700px;
        object-fit: contain;
        border-radius: 14px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
        cursor: zoom-out;
      }

      /* 404 centered */
      .notfound-wrapper {
        height: calc(100vh - 64px);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .notfound {
        text-align: center;
      }
      .notfound h1 {
        font-size: 120px;
        margin: 0;
        line-height: 1;
        color: #d0d3d8;
      }
      .notfound p {
        margin-top: 12px;
        font-size: 18px;
        color: var(--text-soft);
      }

      #charCount {
        font-size: 13px;
        color: var(--muted);
      }

      #charCount.limit {
        color: var(--danger); /* rojo estilo Twitter */
        font-weight: 600;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Defensivo para cualquier texto ingresado por el usuario*/
      .user-text {
        white-space: normal !important;
        overflow-wrap: anywhere;
        word-break: break-word;
      }

      /* ===== TWEET ACTIONS ===== */
      .tweet-actions {
        display: flex;
        gap: 132px;
        margin-top: 14px;
        color: var(--text-soft);
        font-size: 14px;
      }

      .tweet-action {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        user-select: none;
      }

      .tweet-action img {
        width: 18px;
        height: 18px;
        stroke: var(--text-soft);
        fill: var(--bg-card);
      }

      .tweet-action svg {
        width: 18px;
        height: 18px;
        display: block;
      }

      .like-action svg {
        transition: transform 0.15s ease, color 0.15s ease;
      }

      .like-action.liked svg {
        transform: scale(1.2);
      }

      .like-action {
        color: var(--text-soft);
        cursor: pointer;
      }

      .like-action.liked {
        color: #f91880;
      }

      .like-icon {
        width: 20px;
        height: 20px;
      }

      /* responsive */
      @media (max-width: 480px) {
        .container {
          margin: 6px auto;
        }
        .tweet-image img {
          max-height: 300px;
        }
        .notfound h1 {
          font-size: 80px;
        }
      }

      /* RESPONSIVE */
      @media (max-width: 480px) {
        .container {
          margin: 0px;
          border: none;
          padding: 0 0px;
        }
      }

      @media (max-width: 480px) {
        .sidebar {
          width: 100%;
          max-width: 100%;
        }

        .sidebar-user .displayname,
        .sidebar-user .username-small {
          white-space: normal;
          text-align: center;
        }
      }

      @media (max-width: 480px) {
        /* Tweet actions */
        .tweet-actions {
          gap: 12px;
          font-size: 13px;
        }
        .tweet-action img,
        .tweet-action svg {
          width: 16px;
          height: 16px;
        }
        .like-icon {
          width: 18px;
          height: 18px;
        }

        /* Comments */
        .comments {
          padding: 8px;
        }
        .comment-item {
          gap: 8px;
          padding: 8px 0;
        }
        .comment-avatar img {
          width: 36px;
          height: 36px;
        }
        .comment-meta {
          font-size: 13px;
          gap: 4px;
        }
        .comment-content {
          font-size: 14px;
        }
        .comment-input {
          font-size: 14px;
          padding: 6px 8px;
        }
        .comment-btn {
          padding: 6px 10px;
          font-size: 13px;
        }
        #charCount {
          font-size: 12px;
        }

        /* Image lightbox */
        .image-overlay img {
          width: 90vw;
          height: auto;
          max-height: 60vh;
        }

        /* 404 */
        .notfound h1 {
          font-size: 60px;
        }
        .notfound p {
          font-size: 16px;
        }
      }

      @media (max-width: 480px) {
        .tweet-actions {
          gap: 12px;
          flex-wrap: wrap;
        }
        .tweet-image iframe {
          width: 100%;
          height: auto;
        }
      }

      @media (max-width: 480px) {
        .image-overlay {
          padding: 12px;
        }
      }

      @media (max-width: 480px) {
        body {
          font-size: 16px;
        }
      }

      /* Efecto snowflake */
      .snowflake {
        color: #fff;
        font-size: 1em;
        font-family: Arial, sans-serif;
        text-shadow: 0 0 5px #000;
      }
      .snowflake,
      .snowflake .inner {
        animation-iteration-count: infinite;
        animation-play-state: running;
      }
      @keyframes snowflakes-fall {
        0% {
          transform: translateY(0);
        }
        100% {
          transform: translateY(110vh);
        }
      }
      @keyframes snowflakes-shake {
        0%,
        100% {
          transform: translateX(0);
        }
        50% {
          transform: translateX(80px);
        }
      }
      .snowflake {
        position: fixed;
        top: -10%;
        z-index: 9999;
        -webkit-user-select: none;
        user-select: none;
        cursor: default;
        pointer-events: none;
        animation-name: snowflakes-shake;
        animation-duration: 3s;
        animation-timing-function: ease-in-out;
      }
      .snowflake .inner {
        animation-duration: 10s;
        animation-name: snowflakes-fall;
        animation-timing-function: linear;
      }
      .snowflake:nth-of-type(0) {
        left: 1%;
        animation-delay: 0s;
      }
      .snowflake:nth-of-type(0) .inner {
        animation-delay: 0s;
      }
      .snowflake:nth-of-type(1) {
        left: 10%;
        animation-delay: 1s;
      }
      .snowflake:nth-of-type(1) .inner {
        animation-delay: 1s;
      }
      .snowflake:nth-of-type(2) {
        left: 20%;
        animation-delay: 0.5s;
      }
      .snowflake:nth-of-type(2) .inner {
        animation-delay: 6s;
      }
      .snowflake:nth-of-type(3) {
        left: 30%;
        animation-delay: 2s;
      }
      .snowflake:nth-of-type(3) .inner {
        animation-delay: 4s;
      }
      .snowflake:nth-of-type(4) {
        left: 40%;
        animation-delay: 2s;
      }
      .snowflake:nth-of-type(4) .inner {
        animation-delay: 2s;
      }
      .snowflake:nth-of-type(5) {
        left: 50%;
        animation-delay: 3s;
      }
      .snowflake:nth-of-type(5) .inner {
        animation-delay: 8s;
      }
      .snowflake:nth-of-type(6) {
        left: 60%;
        animation-delay: 2s;
      }
      .snowflake:nth-of-type(6) .inner {
        animation-delay: 6s;
      }
      .snowflake:nth-of-type(7) {
        left: 70%;
        animation-delay: 1s;
      }
      .snowflake:nth-of-type(7) .inner {
        animation-delay: 2.5s;
      }
      .snowflake:nth-of-type(8) {
        left: 80%;
        animation-delay: 0s;
      }
      .snowflake:nth-of-type(8) .inner {
        animation-delay: 1s;
      }
      .snowflake:nth-of-type(9) {
        left: 90%;
        animation-delay: 1.5s;
      }
      .snowflake:nth-of-type(9) .inner {
        animation-delay: 3s;
      }
      .snowflake:nth-of-type(10) {
        left: 25%;
        animation-delay: 0s;
      }
      .snowflake:nth-of-type(10) .inner {
        animation-delay: 2s;
      }
      .snowflake:nth-of-type(11) {
        left: 65%;
        animation-delay: 2.5s;
      }
      .snowflake:nth-of-type(11) .inner {
        animation-delay: 4s;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-left">
        <img
          id="headerMoreBtn"
          src="icons/more.png"
          alt="menu"
          class="header-more-btn"
        />
        <a href="feed.html" class="header-title">RED SOCIAL</a>
      </div>
    </header>

    <div id="sidebarBackdrop"></div>
    <aside id="sidebar" class="sidebar" aria-hidden="true">
      <div class="sidebar-user">
        <img
          id="sidebarAvatar"
          src="icons/upload.png"
          alt="me"
          title="Ver perfil"
        />
        <div class="displayname" id="sidebarDisplayName" title="Ver perfil">
          Usuario
        </div>
        <div class="username-small" id="sidebarUsername" title="Ver perfil">
          @usuario
        </div>
      </div>

      <div class="sidebar-nav">
        <a href="feed.html"
          ><img src="icons/home.png" class="sidebar-icon" alt="" /> Home</a
        >
        <a href="requests.html"
          ><img src="icons/add-friend.png" class="sidebar-icon" alt="" />
          Solicitudes</a
        >
        <a href="chat.html"
          ><img src="icons/email.png" class="sidebar-icon" alt="" /> Chat</a
        >
        <a href="user.html"
          ><img src="icons/user.png" class="sidebar-icon" alt="" /> Profile</a
        >
        <a href="options.html" id="sidebarOptions">
          <img src="icons/settings.png" alt="Opciones" class="sidebar-icon" />
          Opciones
        </a>
        <a href="#" id="sidebarLogout"
          ><img src="icons/exit.png" class="sidebar-icon" alt="" /> Log out</a
        >
      </div>
    </aside>

    <div class="container" id="mainContainer">
      <!-- Post area will be injected here -->
      <div id="postArea"></div>
      <!-- Comments area -->
      <div id="commentsArea"></div>
    </div>

    <!-- IMAGE LIGHTBOX -->
    <div id="imageOverlay" class="image-overlay">
      <img id="overlayImg" alt="imagen completa" />
    </div>

    <script src="config.js"></script>

    <script type="module">
      import { fetchWithAuth, forceLogout } from "./auth.js";

      document.body.dataset.theme = localStorage.getItem("mode") || "light";
      document.body.classList.add("theme-loading");

      const API = CONFIG.API_BASE_URL;
      const token = localStorage.getItem("accessToken");
      const myUsername = localStorage.getItem("username");
      const displayName = localStorage.getItem("displayName");
      const avatarUrl = localStorage.getItem("avatarUrl");
      console.log(avatarUrl);
      if (!token) location.href = "login.html";

      /* UTIL / CACHE */
      const cache = new Map();
      async function loadAvatar(url) {
        if (!url) return "https://via.placeholder.com/64";
        if (cache.has(url)) return cache.get(url);
        try {
          const r = await fetchWithAuth(API + url);
          if (!r.ok) return "https://via.placeholder.com/64";
          const o = URL.createObjectURL(await r.blob());
          cache.set(url, o);
          return o;
        } catch {
          return "https://via.placeholder.com/64";
        }
      }
      async function loadImg(url) {
        try {
          const r = await fetchWithAuth(API + url);
          if (!r.ok) return null;
          return URL.createObjectURL(await r.blob());
        } catch {
          return null;
        }
      }

      /* SIDEBAR / HEADER */
      const headerMoreBtn = document.getElementById("headerMoreBtn");
      const sidebar = document.getElementById("sidebar");
      const sidebarBackdrop = document.getElementById("sidebarBackdrop");
      const sidebarAvatar = document.getElementById("sidebarAvatar");
      const sidebarDisplayName = document.getElementById("sidebarDisplayName");
      const sidebarUsernameEl = document.getElementById("sidebarUsername");
      const sidebarLogout = document.getElementById("sidebarLogout");

      function openSidebar() {
        sidebar.classList.add("open");
        sidebarBackdrop.style.display = "block";
        sidebar.setAttribute("aria-hidden", "false");
      }
      function closeSidebar() {
        sidebar.classList.remove("open");
        sidebarBackdrop.style.display = "none";
        sidebar.setAttribute("aria-hidden", "true");
      }
      headerMoreBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        sidebar.classList.contains("open") ? closeSidebar() : openSidebar();
      });
      sidebarBackdrop.addEventListener("click", closeSidebar);
      sidebarDisplayName.innerText = displayName || myUsername;
      sidebarUsernameEl.innerText = "@" + (myUsername || "usuario");
      if (avatarUrl)
        loadAvatar(avatarUrl).then((a) => {
          sidebarAvatar.src = a;
        });
      else {
        sidebarAvatar.src = "https://via.placeholder.com/64";
      }
      sidebarAvatar.addEventListener(
        "click",
        () => (location.href = `user.html?username=${myUsername}`)
      );
      sidebarDisplayName.addEventListener(
        "click",
        () => (location.href = `user.html?username=${myUsername}`)
      );
      sidebarUsernameEl.addEventListener(
        "click",
        () => (location.href = `user.html?username=${myUsername}`)
      );
      sidebarLogout.addEventListener("click", forceLogout);

      function timeAgo(date) {
        const d = new Date(date),
          now = new Date(),
          diff = (now - d) / 1000;
        if (diff < 60) return `${Math.floor(diff)}s`;
        if (diff < 3600) return `${Math.floor(diff / 60)}m`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h`;
        return `${Math.floor(diff / 86400)}d`;
      }
      function renderUserText(text) {
        if (!text) return "";
        let safe = text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
        safe = safe.replace(
          /(https?:\/\/[^\s<]+)/g,
          '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
        );
        safe = safe.replace(/\n/g, "<br>");
        return safe;
      }
      function formatPrivacyIcon(p) {
        switch (p) {
          case "FRIENDS":
            return "üë•";
          case "PRIVATE":
            return "üîí";
          default:
            return "";
        }
      }

      /* IMAGE LIGHTBOX */
      const imageOverlay = document.getElementById("imageOverlay");
      const overlayImg = document.getElementById("overlayImg");
      function openImage(src) {
        overlayImg.src = src;
        imageOverlay.style.display = "flex";
      }
      imageOverlay.addEventListener("click", () => {
        imageOverlay.style.display = "none";
        overlayImg.src = "";
      });

      /* HANDLE OUTSIDE CLICK (close menus) */
      document.addEventListener("click", () => {
        document
          .querySelectorAll(".options-menu, .profile-options-menu")
          .forEach((m) => {
            if (m) m.style.display = "none";
          });
      });

      /* POST ID */
      const postId = new URLSearchParams(location.search).get("id");
      const postArea = document.getElementById("postArea");
      const commentsArea = document.getElementById("commentsArea");

      function show404() {
        // clear container and show centered 404
        postArea.innerHTML = "";
        commentsArea.innerHTML = "";
        document.getElementById("mainContainer").innerHTML = `
                <div class="notfound-wrapper">
                  <div class="notfound">
                    <h1>404</h1>
                    <p>No se encontr√≥ el post.</p>
                  </div>
                </div>
              `;
      }

      if (!postId) {
        show404();
      } else {
        loadPostAndComments(postId);
      }

      async function loadPostAndComments(id) {
        try {
          const r = await fetchWithAuth(`${API}/api/v1/posts/${id}`);
          if (!r.ok) {
            // If backend responds 403 or 404, show 404 page (seg√∫n tu requisito)
            if (r.status === 403 || r.status === 404) {
              show404();
              return;
            }
            // other errors: show message
            postArea.innerHTML = `<div class="empty">Error al cargar el post</div>`;
            return;
          }
          const post = await r.json();
          renderPost(post);
          // load comments (separado)
          await loadComments(id);
        } catch (e) {
          console.error("Error cargando post", e);
          postArea.innerHTML = `<div class="empty">Error al cargar el post</div>`;
        }
      }

      async function renderPost(x) {
        const body = document.createElement("div");
        body.className = "tweet-body";

        // contenido de texto
        const content = document.createElement("div");
        content.className = "tweet-content user-text";
        content.innerHTML = renderUserText(x.content);
        body.appendChild(content);

        // === operaciones as√≠ncronas: imagen / embed ===
        let mediaAppended = false;

        if (x.file) {
          const fileUrl = await loadImg(x.file.url);
          if (fileUrl) {
            const wrap = document.createElement("div");
            wrap.className = "tweet-image";
            const im = document.createElement("img");
            im.src = fileUrl;
            wrap.appendChild(im);
            body.appendChild(wrap);
            wrap.addEventListener("click", () => openImage(fileUrl));
            mediaAppended = true;
          }
        } else {
          const tweetUrlRaw = (x.content || "").match(
            /(https?:\/\/(?:www\.)?(?:twitter|x)\.com\/\w+\/status\/\d+)/
          );
          const tweetUrl = tweetUrlRaw
            ? tweetUrlRaw[1].replace("x.com", "twitter.com")
            : null;
          const yt = (x.content || "").match(
            /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/
          );
          const ytId = yt ? yt[1] : null;

          if (ytId) {
            const wrap = document.createElement("div");
            wrap.className = "tweet-image";
            wrap.innerHTML = `<iframe width="516" height="290" src="https://www.youtube.com/embed/${ytId}" frameborder="0" allowfullscreen></iframe>`;
            body.appendChild(wrap);
            mediaAppended = true;
          } else if (tweetUrl) {
            const wrap = document.createElement("div");
            wrap.className = "tweet-image";
            wrap.innerHTML = `<blockquote class="twitter-tweet"><a href="${tweetUrl}"></a></blockquote>`;
            body.appendChild(wrap);
            if (window.twttr && window.twttr.widgets)
              window.twttr.widgets.load(wrap);
            else {
              const s = document.createElement("script");
              s.src = "https://platform.twitter.com/widgets.js";
              s.async = true;
              s.onload = () => window.twttr.widgets.load(wrap);
              document.body.appendChild(s);
            }
            mediaAppended = true;
          }
        }

        // === acciones, despu√©s de media ===
        const actions = document.createElement("div");
        actions.className = "tweet-actions";
        actions.innerHTML = `
    <div class="tweet-action comment-action">
      <img src="icons/comment.png" class="no-filter filter-dark-mode">
      <span class="comment-count">${x.commentCount}</span>
    </div>
    <div class="tweet-action like-action ${x.liked ? "liked" : ""}">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M15.7 4C18.87 4 21 6.98 21 9.76C21 15.39 12.16 20 12 20C11.84 20 3 15.39 3 9.76C3 6.98 5.13 4 8.3 4C10.12 4 11.31 4.91 12 5.71C12.69 4.91 13.88 4 15.7 4Z"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="like-count">${x.likeCount}</span>
    </div>
  `;
        body.appendChild(actions);
        console.log(x);
        console.log(x.id);

        const likeBtn = actions.querySelector(".like-action");
        likeBtn.addEventListener("click", async () => {
          // estado actual del like
          const currentlyLiked = likeBtn.classList.contains("liked");
          const likeCountSpan = likeBtn.querySelector(".like-count");
          let likeCount = parseInt(likeCountSpan.textContent, 10);

          // === Optimistic UI ===
          likeBtn.classList.toggle("liked", !currentlyLiked);
          likeCountSpan.textContent = currentlyLiked
            ? likeCount - 1
            : likeCount + 1;

          try {
            // fetch al endpoint de like del post
            const res = await fetchWithAuth(
              `${API}/api/v1/posts/${x.id}/like`,
              {
                method: "POST",
              }
            );

            if (!res.ok) throw new Error("Error al dar like");

            // no necesitamos parsear JSON porque tu endpoint no devuelve nada
          } catch (e) {
            console.error(e);
            console.error("No se pudo actualizar el like");

            // revertir el cambio optimista si falla
            likeBtn.classList.toggle("liked", currentlyLiked);
            likeCountSpan.textContent = likeCount;
          }
        });

        // ahora appendear body al tweet
        const tweet = document.createElement("article");
        tweet.className = "tweet";
        const layout = document.createElement("div");
        layout.className = "tweet-layout";

        // avatar
        const avatarDiv = document.createElement("div");
        avatarDiv.className = "tweet-avatar";
        const avatarImg = document.createElement("img");
        loadAvatar(x.author.avatarUrl).then((a) => (avatarImg.src = a));
        avatarDiv.appendChild(avatarImg);

        // header
        const header = document.createElement("div");
        header.className = "tweet-header";
        header.innerHTML = `
    <div class="tweet-user user-text">
      <span class="display-name">${x.author.displayName}</span>
      <span class="username">@${x.author.username}</span>
      <span class="dot">¬∑</span>
      <span class="post-time">${timeAgo(x.createdAt)}</span>
    </div>
    <img src="icons/more.png" class="more-btn no-filter filter-dark-mode" alt="more" >
    <div class="options-menu"></div>
  `;

        // ===== MORE MENU (‚ãÆ) =====
        const moreBtn = header.querySelector(".more-btn");
        const menu = header.querySelector(".options-menu");

        // abrir / cerrar men√∫
        moreBtn.onclick = (e) => {
          e.stopPropagation();

          document.querySelectorAll(".options-menu").forEach((m) => {
            if (m !== menu) m.style.display = "none";
          });

          menu.style.display = menu.style.display === "flex" ? "none" : "flex";
        };

        // SOLO si soy el due√±o del post
        if (x.author.username === myUsername) {
          const del = document.createElement("div");
          del.className = "option delete-option";
          del.innerHTML = `<img src="icons/delete.png"> Eliminar`;

          del.onclick = async (e) => {
            e.stopPropagation();

            const res = await fetchWithAuth(`${API}/api/v1/posts/${x.id}`, {
              method: "DELETE",
            });

            if (res.status === 204) {
              // post eliminado ‚Üí mostrar el MISMO 404 que ya us√°s
              show404();
            } else if (res.status === 403) {
              console.err("No ten√©s permiso para eliminar este post");
            } else if (res.status === 404) {
              show404();
            } else {
              console.err("Error al eliminar el post");
            }
          };

          menu.appendChild(del);
        }

        /*eventos user profile*/
        const displayNameEl = header.querySelector(".display-name");
        const usernameEl = header.querySelector(".username");
        avatarImg.onclick = () =>
          (location.href = `user.html?username=${x.author.username}`);
        displayNameEl.onclick = () =>
          (location.href = `user.html?username=${x.author.username}`);
        usernameEl.onclick = () =>
          (location.href = `user.html?username=${x.author.username}`);

        body.insertBefore(header, content);

        layout.appendChild(avatarDiv);
        layout.appendChild(body);
        tweet.appendChild(layout);
        postArea.appendChild(tweet);
      }

      /* COMMENTS: composer + list */
      async function loadComments(id) {
        commentsArea.innerHTML = `
                <div class="comments">
                  <div class="composer">
                    <div style="display:flex; gap:12px; align-items:flex-start;">
                      <div class="comment-avatar"><img id="myCommentAvatar" alt="mi avatar"></div>
                      <div style="flex:1">
                        <div class="comment-box">
                          <textarea
                              id="commentInput"
                              class="comment-input"
                              placeholder="Agregar un comentario"
                              maxlength="300"
                              ></textarea>

                              <div class="comment-row">
                              <div
                                  id="charCount"
                                  style="color:#657786; font-size:13px"
                              >
                                  0 / 300
                              </div>

                              <button
                                  id="commentBtn"
                                  class="comment-btn"
                                  disabled
                              >
                                  Comentar
                              </button>
                              </div>

                      </div>
                    </div>
                  </div>
                  <div id="commentsList"></div>
                </div>
              `;
        // avatar for composer
        const myAv = document.getElementById("myCommentAvatar");
        if (avatarUrl) loadAvatar(avatarUrl).then((a) => (myAv.src = a));
        else myAv.src = "https://via.placeholder.com/64";

        // input handlers (CORRECTO)
        const commentInput = document.getElementById("commentInput");
        const commentBtn = document.getElementById("commentBtn");
        const charCount = document.getElementById("charCount");

        commentInput.addEventListener("input", () => {
          const length = commentInput.value.length;

          // contador
          charCount.textContent = `${length} / 300`;

          if (length >= 300) {
            charCount.classList.add("limit");
          } else {
            charCount.classList.remove("limit");
          }

          // bot√≥n
          commentBtn.disabled = commentInput.value.trim().length === 0;

          // auto-resize
          commentInput.style.height = "auto";
          commentInput.style.height = commentInput.scrollHeight + "px";
        });

        commentBtn.addEventListener("click", async () => {
          await createComment(postId, commentInput.value.trim());
        });

        // fetch comment list
        try {
          const r = await fetchWithAuth(
            `${API}/api/v1/posts/${postId}/comments`
          );
          if (!r.ok) {
            if (r.status === 403) {
              // no permission to view comments: show notice
              document.getElementById(
                "commentsList"
              ).innerHTML = `<div class="empty">No ten√©s permiso para ver los comentarios de este post.</div>`;
              return;
            } else {
              document.getElementById(
                "commentsList"
              ).innerHTML = `<div class="empty">Error al cargar comentarios</div>`;
              return;
            }
          }
          const list = await r.json();
          renderCommentsList(list || []);
        } catch (e) {
          console.error("Error cargando comentarios", e);
          document.getElementById(
            "commentsList"
          ).innerHTML = `<div class="empty">Error al cargar comentarios</div>`;
        }
      }

      function renderCommentsList(list) {
        const el = document.getElementById("commentsList");
        el.innerHTML = "";
        if (!list.length) {
          el.innerHTML = `<div class="empty">Se el primero en comentar</div>`;
          return;
        }
        for (const c of list) {
          const item = document.createElement("div");
          item.className = "comment-item";
          item.dataset.commentId = c.id;
          const avatarPlaceholder = "https://via.placeholder.com/64";
          // create markup
          item.innerHTML = `
                  <div class="comment-avatar"><img alt="avatar"></div>
                  <div class="comment-body">
                    <div class="comment-meta">
                      <strong class="comment-displayname">${
                        c.author.displayName
                      }</strong>
                      <span class="username">@${c.author.username}</span>
                      <span class="dot">¬∑</span>
                      <span class="comment-time" title="${new Date(
                        c.createdAt
                      ).toLocaleString()}">${timeAgo(c.createdAt)}</span>
                    </div>
                    <div class="comment-content user-text">${renderUserText(
                      c.content
                    )}</div>
                  </div>
                `;
          // avatar
          const avImg = item.querySelector(".comment-avatar img");
          loadAvatar(c.author.avatarUrl).then(
            (a) => (avImg.src = a || avatarPlaceholder)
          );

          // click to profile
          const nameEl = item.querySelector(".comment-displayname");
          const userEl = item.querySelector(".username");
          avImg.onclick =
            nameEl.onclick =
            userEl.onclick =
              () => (location.href = `user.html?username=${c.author.username}`);

          // delete button if mine
          if (c.author.username === myUsername) {
            const btn = document.createElement("button");
            btn.className = "comment-delete-btn";
            btn.innerText = "Eliminar";
            btn.onclick = async () => {
              //if (!confirm("Eliminar comentario?")) return;
              const res = await fetchWithAuth(
                `${API}/api/v1/posts/${postId}/comments/${c.id}`,
                {
                  method: "DELETE",
                }
              );
              if (res.status === 204) item.remove();
              else if (res.status === 403)
                console.err("No pod√©s eliminar este comentario");
              else if (res.status === 404) console.err("Comentario no encontrado");
              else console.err("Error al eliminar comentario");
            };
            // append to meta area (right side)
            const meta = item.querySelector(".comment-meta");
            meta.appendChild(btn);
          }

          el.appendChild(item);
        }
      }

      async function createComment(postIdToUse, content) {
        if (!content) return;
        const btn = document.getElementById("commentBtn");
        btn.disabled = true;
        try {
          const res = await fetchWithAuth(
            `${API}/api/v1/posts/${postIdToUse}/comments`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ content }),
            }
          );
          if (!res.ok) {
            if (res.status === 403) {
              console.err("No ten√©s permiso para comentar este post");
              return;
            }
            console.err("Error al enviar comentario");
            return;
          }
          const created = await res.json();
          // prepend to list
          const listEl = document.getElementById("commentsList");
          // if empty message present, clear it
          if (listEl.querySelector(".empty")) listEl.innerHTML = "";

          const item = document.createElement("div");
          item.className = "comment-item";
          item.dataset.commentId = created.id;
          item.innerHTML = `
                  <div class="comment-avatar"><img alt="avatar"></div>
                  <div class="comment-body">
                    <div class="comment-meta">
                      <strong class="comment-displayname">${
                        created.author.displayName
                      }</strong>
                      <span class="username">@${created.author.username}</span>
                      <span class="dot">¬∑</span>
                      <span class="comment-time" title="${new Date(
                        created.createdAt
                      ).toLocaleString()}">${timeAgo(created.createdAt)}</span>
                    </div>
                    <div class="comment-content user-text">${renderUserText(
                      created.content
                    )}</div>
                  </div>
                `;
          const avImg = item.querySelector(".comment-avatar img");
          loadAvatar(created.author.avatarUrl).then((a) => (avImg.src = a));
          // delete if mine
          if (created.author.username === myUsername) {
            const btn = document.createElement("button");
            btn.className = "comment-delete-btn";
            btn.innerText = "Eliminar";
            btn.onclick = async () => {
              //if (!confirm("Eliminar comentario?")) return;
              const res = await fetchWithAuth(
                `${API}/api/v1/posts/${postId}/comments/${created.id}`,
                {
                  method: "DELETE",
                }
              );
              if (res.status === 204) item.remove();
              else console.err("Error al eliminar comentario");
            };
            item.querySelector(".comment-meta").appendChild(btn);
          }
          // insert at top
          const listParent = document.getElementById("commentsList");
          listParent.insertBefore(item, listParent.firstChild);
          // clear input
          const commentInput = document.getElementById("commentInput");
          commentInput.value = "";
          commentInput.style.height = "auto";
          const charCount = document.getElementById("charCount");
          charCount.textContent = "0 / 300";
          charCount.classList.remove("limit");

          document.getElementById("commentBtn").disabled = true;
        } catch (e) {
          console.error("Error creando comentario", e);
          console.err("Error al enviar comentario");
        } finally {
          btn.disabled = false;
        }
      }

      // header scroll effect
      const header = document.querySelector("header");
      window.addEventListener("scroll", () => {
        if (window.scrollY > 5) header.classList.add("scrolled");
        else header.classList.remove("scrolled");
      });

      /*Color sidebar header banner*/
      function applyUserTheme(color) {
        const root = document.documentElement;

        if (color) {
          root.style.setProperty("--user-color", color);
          root.style.setProperty("--user-color-dark", darkenColor(color, 25));
        } else {
          root.style.setProperty("--user-color", "#1fe1d2");
          root.style.setProperty("--user-color-dark", "#3076e0");
        }
        document.body.classList.remove("theme-loading");
      }

      async function fetchMyProfile() {
        const r = await fetchWithAuth(`${API}/api/v1/users/me`);

        if (!r.ok) throw new Error("No se pudo cargar el perfil");

        return r.json();
      }

      async function initUserTheme() {
        try {
          const u = await fetchMyProfile();
          applyUserTheme(u.bannerColor);
        } catch (e) {
          console.warn("Usando tema por defecto", e);
          applyUserTheme(null);
        }
      }
      function darkenColor(hex, percent) {
        const num = parseInt(hex.replace("#", ""), 16);
        const amt = Math.round(2.55 * percent);
        const r = Math.max(0, (num >> 16) - amt);
        const g = Math.max(0, ((num >> 8) & 0x00ff) - amt);
        const b = Math.max(0, (num & 0x0000ff) - amt);

        return `rgb(${r}, ${g}, ${b})`;
      }
      initUserTheme();
    </script>
    <div class="snowflakes" aria-hidden="true">
      <div class="snowflake"><div class="inner">‚ùÑ</div></div>
      <div class="snowflake"><div class="inner">‚ùÑ</div></div>
      <div class="snowflake"><div class="inner">‚ùÑ</div></div>
      <div class="snowflake"><div class="inner">‚ùÑ</div></div>
      <div class="snowflake"><div class="inner">‚ùÑ</div></div>
      <div class="snowflake"><div class="inner">‚ùÑ</div></div>
      <div class="snowflake"><div class="inner">‚ùÑ</div></div>
      <div class="snowflake"><div class="inner">‚ùÑ</div></div>
      <div class="snowflake"><div class="inner">‚ùÑ</div></div>
      <div class="snowflake"><div class="inner">‚ùÑ</div></div>
      <div class="snowflake"><div class="inner">‚ùÑ</div></div>
      <div class="snowflake"><div class="inner">‚ùÑ</div></div>
    </div>
  </body>
</html>
