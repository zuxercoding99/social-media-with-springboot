<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="icons/favicon.png" />
    <title>Solicitudes - Red Social</title>

    <style>
      /* -----------------------
     THEME & COLOR VARIABLES
     ----------------------- */
      :root {
        --user-color: #1fe1d2;
        --user-color-dark: #3076e0;

        /* LIGHT (keeps current light-mode look) */
        --bg-main: #ffffff; /* page background */
        --bg-card: #ffffff; /* cards / containers */
        --bg-soft: #f5f8fa; /* subtle backgrounds (hover, chat, etc) */

        --text-main: #0f1419; /* primary text */
        --text-soft: #657786; /* secondary / meta text */

        --border-soft: #eff3f4; /* soft borders */
        --border: #ccd6dd;

        --hover-soft: #f5f8fa;
        --link-color: #1d9bf0;

        --danger: #e0245e;
        --success: #17bf63;
        --warn: #ffad1f;

        --post-disabled: #aab8c2;
        --overlay-bg: rgba(255, 255, 255, 0.95);
      }

      /* DARK MODE OVERRIDES (activate with body[data-theme="dark"]) */
      body[data-theme="dark"] {
        --bg-main: #0f1419;
        --bg-card: #1d1f23;
        --bg-soft: #16181c;

        --text-main: #e7e9ea;
        --text-soft: #8b98a5;

        --border-soft: #2f3336;
        --border: #2f3336;

        --hover-soft: #202327;
        --link-color: #1d9bf0;

        --danger: #f9708d;
        --success: #3ddc84;
        --warn: #b37a12;

        --post-disabled: #3a4146;
        --overlay-bg: rgba(0, 0, 0, 0.85);
      }

      /* -----------------------
     GENERAL
     ----------------------- */
      body.theme-loading header,
      body.theme-loading .sidebar::before {
        opacity: 0;
      }

      body {
        transition: opacity 0.25s ease;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        line-height: 1.4;
        color: var(--text-main);
        margin: 0;
        background: var(--bg-main);
      }

      /* Defensivo para cualquier texto ingresado por el usuario*/
      .user-text {
        overflow-wrap: break-word;
        word-wrap: break-word;
        white-space: normal;
      }

      /* HEADER + SIDEBAR (idéntico a feed.html) */
      header {
        background: linear-gradient(
          135deg,
          var(--user-color),
          var(--user-color-dark)
        );
        color: white;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 1500;
      }
      .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: bold;
        font-size: 18px;
      }
      .header-more-btn {
        width: 18px;
        height: 18px;
        cursor: pointer;
        filter: invert(1);
        opacity: 0.95;
      }

      #sidebarBackdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.18);
        display: none;
        z-index: 1200;
      }
      .sidebar-icon {
        filter: none;
      }
      body[data-theme="dark"] .sidebar-icon {
        filter: invert(1) brightness(0.95);
      }
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100%;
        width: 220px;
        max-width: 80%;
        background: var(--bg-card);
        box-shadow: 2px 0 12px rgba(0, 0, 0, 0.12);
        z-index: 1300;
        transform: translateX(-100%);
        transition: transform 0.22s ease;
        display: flex;
        flex-direction: column;
        padding: 12px;
        /* dejar overflow hidden en el contenedor principal para evitar 'double scroll' */
        overflow: hidden;
      }

      .sidebar-nav a:hover {
        background: color-mix(in srgb, var(--user-color), var(--bg-card) 85%);
      }
      .sidebar-nav a.active {
        color: var(--user-color);
      }

      .sidebar::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        height: 120px;
        width: 100%;
        background: linear-gradient(
          135deg,
          var(--user-color),
          var(--user-color-dark)
        );
        z-index: -1;
      }
      .sidebar.open {
        transform: translateX(0);
      }

      .sidebar-user {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 40px 0 24px;

        flex: 0 0 auto;
      }
      .sidebar-user img {
        width: 96px;
        height: 96px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
      }
      .sidebar-user .displayname {
        font-size: 20px;
        font-weight: bold;
        color: var(--text-main);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .sidebar-user .username-small {
        color: var(--text-soft);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* la nav ocupa el resto y puede scrollear */
      .sidebar-nav {
        flex: 1 1 auto; /* ocupa el resto del alto disponible */
        overflow-y: auto; /* aquí activamos scroll cuando haga falta */
        padding-right: 6px; /* para que no choque con scrollbar */
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      /* suaviza scroll en iOS */
      .sidebar-nav {
        -webkit-overflow-scrolling: touch;
      }

      /* opcional: estilos para scrollbar */
      .sidebar-nav::-webkit-scrollbar {
        width: 10px;
      }
      .sidebar-nav::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.12);
        border-radius: 10px;
      }

      .sidebar-nav a {
        text-decoration: none;
        color: var(--text-main);
        font-weight: 600;
        padding: 12px 16px;
        border-radius: 12px;
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .sidebar-nav a:hover {
        background: var(--hover-soft);
      }

      /* LAYOUT */
      .container {
        width: 100%;
        max-width: 618px;
        margin: 0 auto;
        padding: 0;
        background: var(--bg-card);
      }
      .section {
        margin-bottom: 30px;
      }
      .section h2 {
        font-size: 18px;
        margin-bottom: 12px;
        color: var(--text-main);
      }

      /* request card (discord-like) */
      .request {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        border: 1px solid var(--border-soft);
      }
      .req-left {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .req-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
      }
      .req-name {
        font-weight: 700;
        color: var(--text-main);
      }
      .req-user {
        font-size: 13px;
        color: var(--text-soft);
      }

      .actions {
        display: flex;
        gap: 8px;
      }

      button {
        border: none;
        border-radius: 20px;
        padding: 6px 12px;
        font-weight: bold;
        cursor: pointer;
        background: transparent;
        color: var(--text-main);
      }

      .accept {
        background: var(--success);
        color: white;
      }
      .reject {
        background: var(--danger);
        color: white;
      }
      .block {
        background: var(--warn);
        color: #111;
      }
      .cancel {
        background: var(--text-soft);
        color: white;
      }

      .empty {
        text-align: center;
        color: var(--text-soft);
        padding: 20px;
      }

      /* RESPONSIVE */
      @media (max-width: 480px) {
        .container {
          margin: 0;
          border: none;
          padding: 0 0px;
        }

        .sidebar {
          width: 100%;
          max-width: 100%;
        }
        .sidebar-user .displayname,
        .sidebar-user .username-small {
          white-space: normal;
          text-align: center;
        }
      }

      @media (max-width: 480px) {
        .profile-main {
          padding-top: 16px;
        }
        .profile-avatar.big {
          width: 100px;
          height: 100px;
          top: -75px;
          left: 50%;
          transform: translateX(-50%);
          margin: 0 auto;
          text-align: center;
        }
        .profile-info {
          padding-top: 12px;
          text-align: center;
        }
        .profile-top-actions {
          position: static;
          justify-content: center;
          margin-bottom: 10px;
        }
      }

      @media (max-width: 480px) {
        .tweet-actions {
          gap: 12px;
          flex-wrap: wrap;
        }
        .tweet-image iframe {
          width: 100%;
          height: auto;
        }
      }

      @media (max-width: 480px) {
        .image-overlay {
          padding: 12px;
        }
      }

      @media (max-width: 480px) {
        body {
          font-size: 16px;
        }
      }

      /* Duplicate safe fallback: ensure sidebar responsive block exists */
      @media (max-width: 480px) {
        .sidebar {
          width: 100%;
          max-width: 100%;
        }
        .sidebar-user .displayname,
        .sidebar-user .username-small {
          white-space: normal;
          text-align: center;
        }
      }
    </style>
  </head>

  <body>
    <header>
      <div class="header-left">
        <img id="headerMoreBtn" src="icons/more.png" class="header-more-btn" />
        <a href="feed.html" style="color: white; text-decoration: none"
          >RED SOCIAL</a
        >
      </div>
    </header>

    <div id="sidebarBackdrop"></div>
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-user">
        <img id="sidebarAvatar" />
        <div class="displayname" id="sidebarDisplayName"></div>
        <div class="username-small" id="sidebarUsername"></div>
      </div>
      <div class="sidebar-nav">
        <a href="feed.html"
          ><img src="icons/home.png" class="sidebar-icon" alt="" /> Home</a
        >
        <a href="requests.html"
          ><img src="icons/add-friend.png" class="sidebar-icon" alt="" />
          Solicitudes</a
        >
        <a href="chat.html"
          ><img src="icons/email.png" class="sidebar-icon" alt="" /> Chat</a
        >
        <a href="user.html"
          ><img src="icons/user.png" class="sidebar-icon" alt="" /> Profile</a
        >
        <a href="options.html" id="sidebarOptions">
          <img src="icons/settings.png" alt="Opciones" class="sidebar-icon" />
          Opciones
        </a>
        <a href="#" id="sidebarLogout"
          ><img src="icons/exit.png" class="sidebar-icon" alt="" /> Log out</a
        >
      </div>
    </aside>

    <div class="container">
      <div class="section">
        <h2>Solicitudes recibidas pendientes</h2>
        <div id="received"></div>
      </div>

      <div class="section">
        <h2>Solicitudes enviadas pendientes</h2>
        <div id="sent"></div>
      </div>
    </div>

    <script>
      document.body.dataset.theme = localStorage.getItem("mode") || "light";
      document.body.classList.add("theme-loading");
      const API = "http://localhost:8080";
      const token = localStorage.getItem("accessToken");
      const username = localStorage.getItem("username");
      const displayName = localStorage.getItem("displayName");
      const avatarUrl = localStorage.getItem("avatarUrl");

      if (!token) location.href = "login.html";

      /* avatar loader */
      async function loadAvatar(url) {
        if (!url) return "https://via.placeholder.com/48";
        const r = await fetch(API + url, {
          headers: { Authorization: "Bearer " + token },
        });
        return URL.createObjectURL(await r.blob());
      }

      /* sidebar */
      const sidebar = document.getElementById("sidebar");
      const backdrop = document.getElementById("sidebarBackdrop");
      document.getElementById("headerMoreBtn").onclick = () => {
        sidebar.classList.toggle("open");
        backdrop.style.display = sidebar.classList.contains("open")
          ? "block"
          : "none";
      };
      backdrop.onclick = () => {
        sidebar.classList.remove("open");
        backdrop.style.display = "none";
      };

      document.getElementById("sidebarDisplayName").innerText =
        displayName || username;
      document.getElementById("sidebarUsername").innerText = "@" + username;
      if (avatarUrl) loadAvatar(avatarUrl).then((a) => (sidebarAvatar.src = a));

      sidebarLogout.onclick = () => {
        localStorage.clear();
        location.href = "login.html";
      };

      /* ===== Requests ===== */
      const receivedEl = document.getElementById("received");
      const sentEl = document.getElementById("sent");

      async function loadAll() {
        loadReceived();
        loadSent();
      }

      async function loadReceived() {
        const r = await fetch(API + "/api/v1/users/me/requests-received", {
          headers: { Authorization: "Bearer " + token },
        });
        const arr = await r.json();
        if (!arr.length) {
          receivedEl.innerHTML =
            '<div class="empty">No hay solicitudes pendientes</div>';
          return;
        }
        receivedEl.innerHTML = "";
        for (const u of arr) {
          const av = await loadAvatar(u.avatarUrl);
          receivedEl.innerHTML += `
      <div class="request">
        <div class="req-left">
          <img class="req-avatar" src="${av}">
          <div>
            <div class="req-name">${u.requesterDisplayName}</div>
            <div class="req-user">@${u.requesterUsername}</div>
          </div>
        </div>
        <div class="actions">
          <button class="accept" onclick="accept('${u.requesterId}')">Aceptar</button>
          <button class="reject" onclick="reject('${u.requesterId}')">Rechazar</button>
          <button class="block" onclick="block('${u.requesterId}')">Bloquear</button>
        </div>
      </div>`;
        }
      }

      async function loadSent() {
        const r = await fetch(API + "/api/v1/users/me/requests-sent", {
          headers: { Authorization: "Bearer " + token },
        });
        const arr = await r.json();
        if (!arr.length) {
          sentEl.innerHTML =
            '<div class="empty">No hay solicitudes enviadas</div>';
          return;
        }
        sentEl.innerHTML = "";
        for (const u of arr) {
          const av = await loadAvatar(u.avatarUrl);
          sentEl.innerHTML += `
      <div class="request">
        <div class="req-left">
          <img class="req-avatar" src="${av}">
          <div>
            <div class="req-name">${u.requesterDisplayName}</div>
            <div class="req-user">@${u.requesterUsername}</div>
          </div>
        </div>
        <button class="cancel" onclick="cancel('${u.requesterId}')">Cancelar</button>
      </div>`;
        }
      }

      /* actions */
      const h = { Authorization: "Bearer " + token };
      const accept = (id) =>
        fetch(API + "/api/v1/friends/accept/" + id, {
          method: "POST",
          headers: h,
        }).then(() => location.reload());
      const reject = (id) =>
        fetch(API + "/api/v1/friends/reject/" + id, {
          method: "POST",
          headers: h,
        }).then(() => location.reload());
      const cancel = (id) =>
        fetch(API + "/api/v1/friends/cancel/" + id, {
          method: "DELETE",
          headers: h,
        }).then(() => location.reload());
      const block = (id) =>
        fetch(API + "/api/v1/friends/block/" + id, {
          method: "POST",
          headers: h,
        }).then(() => location.reload());

      loadAll();

      /*Color sidebar header banner*/
      function applyUserTheme(color) {
        const root = document.documentElement;

        if (color) {
          root.style.setProperty("--user-color", color);
          root.style.setProperty("--user-color-dark", darkenColor(color, 25));
        } else {
          root.style.setProperty("--user-color", "#1fe1d2");
          root.style.setProperty("--user-color-dark", "#3076e0");
        }
        document.body.classList.remove("theme-loading");
      }

      async function fetchMyProfile() {
        const r = await fetch(`${API}/api/v1/users/me`, {
          headers: { Authorization: "Bearer " + token },
        });

        if (!r.ok) throw new Error("No se pudo cargar el perfil");

        return r.json();
      }

      async function initUserTheme() {
        try {
          const u = await fetchMyProfile();
          applyUserTheme(u.bannerColor);
        } catch (e) {
          console.warn("Usando tema por defecto", e);
          applyUserTheme(null);
        }
      }
      function darkenColor(hex, percent) {
        const num = parseInt(hex.replace("#", ""), 16);
        const amt = Math.round(2.55 * percent);
        const r = Math.max(0, (num >> 16) - amt);
        const g = Math.max(0, ((num >> 8) & 0x00ff) - amt);
        const b = Math.max(0, (num & 0x0000ff) - amt);

        return `rgb(${r}, ${g}, ${b})`;
      }
      initUserTheme();
    </script>
  </body>
</html>
