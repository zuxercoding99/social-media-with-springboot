<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Feed - Red Social</title>

    <style>
      :root {
        --user-color: #1fe1d2;
        --user-color-dark: #3076e0;
      }

      body.theme-loading header,
      body.theme-loading .sidebar::before {
        opacity: 0;
      }

      body {
        transition: opacity 0.25s ease;
      }

      * {
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        line-height: 1.4;
        color: #0f1419;
        margin: 0;
        background: #fff;
      }

      /* HEADER */
      header {
        background: linear-gradient(
          135deg,
          var(--user-color),
          var(--user-color-dark)
        );
        color: white;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        position: sticky;
        top: 0;
        z-index: 1500;
        transition: background 0.3s, opacity 0.3s;
      }
      header.scrolled {
        opacity: 0.62;
      }

      header a.header-title {
        color: white;
        text-decoration: none;
        font-weight: bold;
        cursor: pointer;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: bold;
        font-size: 18px;
      }
      .header-more-btn {
        width: 18px;
        height: 18px;
        cursor: pointer;
        filter: invert(1);
        opacity: 0.95;
      }
      .header-more-btn:hover {
        opacity: 0.8;
        transform: scale(1.05);
        transition: 0.12s;
      }

      /* SIDEBAR */
      #sidebarBackdrop {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.18);
        display: none;
        z-index: 1200;
      }
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100%;
        width: 220px;
        max-width: 80%;
        background: white;
        box-shadow: 2px 0 12px rgba(0, 0, 0, 0.12);
        z-index: 1300;
        transform: translateX(-100%);
        transition: transform 0.22s ease;
        display: flex;
        flex-direction: column;
        padding: 12px;
        overflow: hidden;
      }

      .sidebar-nav a:hover {
        background: color-mix(in srgb, var(--user-color), white 85%);
      }

      .sidebar-nav a.active {
        color: var(--user-color);
      }

      .sidebar::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        height: 120px;
        width: 100%;
        background: linear-gradient(
          135deg,
          var(--user-color),
          var(--user-color-dark)
        );
        z-index: -1;
      }

      .sidebar.open {
        transform: translateX(0);
      }
      .sidebar-user {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 14px;
        padding-top: 40px;
        padding-bottom: 24px;
      }
      .sidebar-user img {
        width: 96px;
        height: 96px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
      }
      .sidebar-user .displayname {
        font-weight: bold;
        font-size: 20px;
        color: #000;

        max-width: 100%;
        text-align: center;

        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .sidebar-user .username-small {
        font-size: 16px;
        color: #657786;

        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .sidebar-nav {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 24px;
      }
      .sidebar-nav a {
        display: flex;
        align-items: center;
        gap: 12px;
        color: #111;
        text-decoration: none;
        padding: 12px 16px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
      }
      .sidebar-nav a img {
        width: 24px;
        height: 24px;
        object-fit: cover;
      }
      .sidebar-nav a:hover {
        background: #f5f8fa;
      }

      /* LAYOUT */
      .container {
        width: 100%;
        max-width: 618px;
        margin: 12px auto;
        padding: 0;
        background: white;
        border-left: 1px solid #eff3f4;
        border-right: 1px solid #eff3f4;
      }

      /* COMPOSER */
      .composer {
        background: white;
        padding: 15px;
        /* como en user.html: sin sombra exagerada */
        border-bottom: 1px solid #eff3f4;
        display: flex;
        gap: 12px;
      }
      .composer-avatar img {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
      }
      .composer-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .privacy-select {
        width: 100px;
        height: 24px;
        border: 1px solid #1da1f2;
        border-radius: 6px;
        color: #1da1f2;
        font-weight: bold;
        background: white;
        padding: 2px 6px;
      }

      .composer textarea {
        width: 100%;
        border: none;
        resize: none;
        font-size: 15px;
        min-height: 50px;
        margin-top: 4px;
        outline: none;
      }

      .composer-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;

        border-top: 1px solid #eff3f4;
        padding-top: 8px;
        margin-top: 8px;
      }

      .footer-left {
        display: flex;
        align-items: center;
      }

      .footer-right {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .counter {
        font-size: 13px;
        color: #657786;
      }

      .file-label img {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }
      #file {
        display: none;
      }
      .post-btn {
        width: 72px;
        height: 36px;
        background: #1da1f2;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
      }
      .post-btn:disabled {
        background: #aab8c2;
        cursor: default;
      }

      .preview-container {
        display: none;
        margin-top: 6px;
        position: relative;
        border-radius: 12px;
        overflow: hidden;
      }
      .preview-container img {
        width: 100%;
        height: auto;
        object-fit: contain;
        display: block;
      }
      .preview-container .close-btn {
        position: absolute;
        right: 6px;
        top: 6px;
        width: 24px;
        height: 24px;
        cursor: pointer;
      }

      /* TWEET (unificado con user.html) */
      .tweet {
        margin: 0 auto;
        padding: 12px 16px 0;
        background: white;
        border-top: 1px solid #eff3f4;
        border-radius: 0;
      }
      .tweet-layout {
        display: flex;
        align-items: flex-start;
        gap: 12px;
      }
      .tweet-avatar {
        width: 40px;
        flex-shrink: 0;
      }
      .tweet-avatar img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
      }
      .tweet-body {
        flex: 1;
        padding-bottom: 12px;
        min-width: 0;
      }
      .tweet-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
        gap: 8px;
      }
      .tweet-user {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        min-width: 0;
        font-size: 15px;
      }

      .tweet-user .display-name {
        padding: 0px 6px 0px 0px;
        font-size: 15px;
      }

      .tweet-user .dot {
        padding: 0px 6px;
      }

      /* ===== FIX iconos men√∫ ‚ãÆ FEED ===== */
      .tweet-header .options-menu .option {
        display: flex;
        align-items: center;
        gap: 10px;

        line-height: 1.2;
        white-space: nowrap;
      }

      .tweet-header .options-menu .option img {
        width: 16px;
        height: 16px;

        display: block;
        flex-shrink: 0;
        object-fit: contain;
      }

      .display-name {
        font-weight: bold;
        color: #000;
        cursor: pointer;
      }
      .username {
        font-size: 15px;
        color: #657786;
        cursor: pointer;
      }
      .post-time {
        font-size: 15px;
        color: #657786;

        white-space: nowrap;
      }
      .tweet-privacy-inline {
        font-size: 13px;
        color: rgb(83, 100, 113);
        white-space: nowrap;
        opacity: 0.85;
        margin-left: 6px;
      }
      .tweet-content {
        font-size: 15px;
        line-height: 1.45;
        word-wrap: break-word;
        white-space: pre-wrap;
      }

      .tweet-content a,
      .user-text a,
      .bio a {
        color: #1d9bf0;
        text-decoration: none;
      }

      .tweet-content a:hover {
        text-decoration: underline;
      }

      .tweet-image {
        margin-top: 12px;
        cursor: pointer;
        border-radius: 16px;
        overflow: hidden;

        max-height: auto;
        max-width: 516px;

        display: flex;
        align-items: center;
        justify-content: flex-start;

        background: #fff;
      }

      .tweet-image img {
        max-width: 100%;
        max-height: 500px;
        border: 1px solid #eff3f4;

        width: auto;
        height: auto;

        object-fit: contain;
        display: block;

        border-radius: 16px; /* üëà redondeo real */
        overflow: hidden; /* üëà recorte limpio */
      }

      /* MENU ‚ãÆ */
      .more-btn {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
        cursor: pointer;
        opacity: 0.8;
      }
      .more-btn:hover {
        opacity: 1;
      }
      .options-menu {
        position: absolute;
        top: 28px;
        right: 0;
        background: white;
        border: 1px solid #eff3f4;
        border-radius: 12px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        display: none;
        flex-direction: column;
        min-width: 160px;
        padding: 6px 0;
        z-index: 50;
      }
      .options-menu .option {
        padding: 10px 14px;
        display: flex;
        gap: 10px;
        align-items: center;
        cursor: pointer;
        font-size: 14px;
      }
      .options-menu .option:hover {
        background: #f5f8fa;
      }
      .options-menu .delete-option {
        color: #e0245e;
      }

      .empty {
        text-align: center;
        color: #657786;
        margin: 30px 0;
      }

      /* IMAGE LIGHTBOX */
      .image-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.95);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        padding: 24px;
      }
      .image-overlay img {
        width: 80vw;
        height: 80vh;
        max-width: 900px;
        max-height: 700px;
        object-fit: contain;
        border-radius: 14px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
        cursor: zoom-out;
      }

      /* Defensivo para cualquier texto ingresado por el usuario*/
      .user-text {
        white-space: normal !important;
        overflow-wrap: anywhere;
        word-break: break-word;
      }

      /* zona clickeable del post */
      .tweet-clickable {
        cursor: pointer;
        padding: 4px 0;
        border-radius: 8px;
        transition: background 0.15s ease;
      }

      .tweet-clickable:hover {
        background: #f5f8fa;
      }

      /* ===== TWEET ACTIONS ===== */
      .tweet-actions {
        display: flex;
        gap: 132px;
        margin-top: 14px;
        color: #657786;
        font-size: 14px;
      }

      .tweet-action {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        user-select: none;
      }

      .tweet-action img {
        width: 18px;
        height: 18px;
        stroke: #657786;
        fill: white;
      }

      .tweet-action svg {
        width: 18px;
        height: 18px;
        display: block;
      }

      .like-action svg {
        transition: transform 0.15s ease, color 0.15s ease;
      }

      .like-action.liked svg {
        transform: scale(1.2);
      }

      .like-action {
        color: #657786;
        cursor: pointer;
      }

      .like-action.liked {
        color: #f91880;
      }

      .like-icon {
        width: 20px;
        height: 20px;
      }

      /* responsive */
      @media (max-width: 480px) {
        .composer {
          flex-direction: column;
        }

        .container {
          margin: 6px auto;
        }
      }

      @media (max-width: 480px) {
        .container {
          margin: 0px;
          border: none;
          padding: 0 0px;
        }

        @media (max-width: 480px) {
          .sidebar {
            width: 100%;
            max-width: 100%;
          }
          .sidebar-user .displayname,
          .sidebar-user .username-small {
            white-space: normal;
            text-align: center;
          }
        }

        @media (max-width: 480px) {
          .tweet-actions {
            gap: 12px;
            flex-wrap: wrap;
          }
          .tweet-image iframe {
            width: 100%;
            height: auto;
          }
        }

        @media (max-width: 480px) {
          .image-overlay {
            padding: 12px;
          }
        }

        @media (max-width: 480px) {
          body {
            font-size: 16px;
          }
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-left">
        <img
          id="headerMoreBtn"
          src="icons/more.png"
          alt="menu"
          class="header-more-btn"
        />
        <a href="feed.html" class="header-title">RED SOCIAL</a>
      </div>
    </header>

    <div id="sidebarBackdrop"></div>
    <aside id="sidebar" class="sidebar" aria-hidden="true">
      <div class="sidebar-user">
        <img
          id="sidebarAvatar"
          src="icons/upload.png"
          alt="me"
          title="Ver perfil"
        />
        <div class="displayname" id="sidebarDisplayName" title="Ver perfil">
          Usuario
        </div>
        <div class="username-small" id="sidebarUsername" title="Ver perfil">
          @usuario
        </div>
      </div>

      <div class="sidebar-nav">
        <a href="feed.html"><img src="icons/home.png" alt="" /> Home</a>
        <a href="requests.html"
          ><img src="icons/add-friend.png" alt="" /> Solicitudes</a
        >
        <a href="chat.html"><img src="icons/email.png" alt="" /> Chat</a>
        <a href="user.html"><img src="icons/user.png" alt="" /> Profile</a>
        <a href="#" id="sidebarLogout"
          ><img src="icons/exit.png" alt="" /> Log out</a
        >
      </div>
    </aside>

    <div class="container">
      <!-- composer -->
      <div class="composer">
        <div class="composer-avatar"><img id="myAvatar" alt="mi avatar" /></div>
        <div class="composer-body">
          <div style="display: flex; gap: 8px; align-items: center">
            <select id="privacy" class="privacy-select">
              <option value="PUBLIC">P√∫blico</option>
              <option value="FRIENDS">Amigos</option>
              <option value="PRIVATE">Privado</option>
            </select>
          </div>
          <textarea id="content" placeholder="¬øQu√© est√° pasando?"></textarea>

          <div id="previewContainer" class="preview-container">
            <img id="preview" alt="preview" />
            <img
              src="icons/close.png"
              class="close-btn"
              onclick="removePreview()"
              alt="close"
            />
          </div>

          <div class="composer-footer">
            <div class="footer-left">
              <label for="file" class="file-label" title="Subir imagen"
                ><img src="icons/upload.png" alt="upload"
              /></label>
              <input
                type="file"
                id="file"
                accept=".jpg,.jpeg,.png"
                onchange="previewImg()"
              />
            </div>
            <div class="footer-right">
              <span id="counter" class="counter">0 / 300</span>
              <button
                id="postBtn"
                class="post-btn"
                disabled
                onclick="publish()"
              >
                Post
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- feed container -->
      <div id="feed"></div>
    </div>

    <!-- lightbox -->
    <div id="imageOverlay" class="image-overlay">
      <img id="overlayImg" alt="imagen completa" />
    </div>

    <script>
      document.body.classList.add("theme-loading");

      const API = "http://localhost:8080";
      const token = localStorage.getItem("accessToken");
      const username = localStorage.getItem("username");
      const displayName = localStorage.getItem("displayName");
      const avatarUrl = localStorage.getItem("avatarUrl");
      if (!token) location.href = "login.html";

      const MAX = 300;
      const cache = new Map();
      const feedEl = document.getElementById("feed");

      /* ---------- SIDEBAR / HEADER ---------- */
      const headerMoreBtn = document.getElementById("headerMoreBtn");
      const sidebar = document.getElementById("sidebar");
      const sidebarBackdrop = document.getElementById("sidebarBackdrop");
      const sidebarAvatar = document.getElementById("sidebarAvatar");
      const sidebarDisplayName = document.getElementById("sidebarDisplayName");
      const sidebarUsernameEl = document.getElementById("sidebarUsername");
      const sidebarLogout = document.getElementById("sidebarLogout");
      const myAvatar = document.getElementById("myAvatar");

      function openSidebar() {
        sidebar.classList.add("open");
        sidebarBackdrop.style.display = "block";
        sidebar.setAttribute("aria-hidden", "false");
      }
      function closeSidebar() {
        sidebar.classList.remove("open");
        sidebarBackdrop.style.display = "none";
        sidebar.setAttribute("aria-hidden", "true");
      }

      headerMoreBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        sidebar.classList.contains("open") ? closeSidebar() : openSidebar();
      });
      sidebarBackdrop.addEventListener("click", closeSidebar);

      sidebarDisplayName.innerText = displayName || username;
      sidebarUsernameEl.innerText = "@" + (username || "usuario");
      if (avatarUrl) {
        loadAvatar(avatarUrl).then((a) => {
          sidebarAvatar.src = a;
          myAvatar.src = a;
        });
      } else {
        sidebarAvatar.src = "https://via.placeholder.com/64";
        myAvatar.src = "https://via.placeholder.com/64";
      }

      sidebarAvatar.addEventListener(
        "click",
        () => (location.href = `user.html?username=${username}`)
      );
      sidebarDisplayName.addEventListener(
        "click",
        () => (location.href = `user.html?username=${username}`)
      );
      sidebarUsernameEl.addEventListener(
        "click",
        () => (location.href = `user.html?username=${username}`)
      );
      sidebarLogout.addEventListener("click", () => {
        localStorage.clear();
        location.href = "login.html";
      });

      /* ---------- UTIL ---------- */
      async function loadAvatar(url) {
        if (!url) return "https://via.placeholder.com/64";
        if (cache.has(url)) return cache.get(url);
        try {
          const r = await fetch(API + url, {
            headers: { Authorization: "Bearer " + token },
          });
          if (!r.ok) return "https://via.placeholder.com/64";
          const o = URL.createObjectURL(await r.blob());
          cache.set(url, o);
          return o;
        } catch {
          return "https://via.placeholder.com/64";
        }
      }
      async function loadImg(url) {
        try {
          const r = await fetch(API + url, {
            headers: { Authorization: "Bearer " + token },
          });
          if (!r.ok) return null;
          return URL.createObjectURL(await r.blob());
        } catch {
          return null;
        }
      }
      function timeAgo(date) {
        const d = new Date(date),
          now = new Date(),
          diff = (now - d) / 1000;
        if (diff < 60) return `${Math.floor(diff)}s`;
        if (diff < 3600) return `${Math.floor(diff / 60)}m`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h`;
        return `${Math.floor(diff / 86400)}d`;
      }

      function extractTweetUrl(text) {
        const m = text.match(
          /(https?:\/\/(?:www\.)?(?:twitter|x)\.com\/\w+\/status\/\d+)/
        );
        return m ? m[1] : null;
      }

      function extractYouTubeId(text) {
        const m = text.match(
          /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/
        );
        return m ? m[1] : null;
      }

      function renderUserText(text) {
        if (!text) return "";

        // 1Ô∏è‚É£ Escapar HTML (SEGURIDAD)
        let safe = text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");

        // 2Ô∏è‚É£ Convertir URLs en links
        safe = safe.replace(
          /(https?:\/\/[^\s<]+)/g,
          '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
        );

        // 3Ô∏è‚É£ Respetar saltos de l√≠nea
        safe = safe.replace(/\n/g, "<br>");

        return safe;
      }

      /* ---------- PRIVACY FORMAT (solo iconos para FRIENDS/PRIVATE) ---------- */
      function formatPrivacyIcon(p) {
        switch (p) {
          case "FRIENDS":
            return "üë•";
          case "PRIVATE":
            return "üîí";
          default:
            return ""; // PUBLIC -> nada
        }
      }

      /* ---------- TEXTAREA auto-grow y contador ---------- */
      const content = document.getElementById("content");
      const counter = document.getElementById("counter");
      const postBtn = document.getElementById("postBtn");
      content.addEventListener("input", () => {
        if (content.value.length > MAX)
          content.value = content.value.slice(0, MAX);
        content.style.height = "auto";
        content.style.height = content.scrollHeight + "px";
        counter.innerText = `${content.value.length} / ${MAX}`;
        postBtn.disabled = !content.value.trim();
      });

      /* ---------- IMAGE PREVIEW ---------- */
      function previewImg() {
        const file = document.getElementById("file");
        if (!file.files[0]) return;
        const container = document.getElementById("previewContainer");
        const img = document.getElementById("preview");
        img.src = URL.createObjectURL(file.files[0]);
        container.style.display = "block";
      }
      function removePreview() {
        const file = document.getElementById("file");
        file.value = "";
        document.getElementById("previewContainer").style.display = "none";
      }

      /* ---------- PUBLISH ---------- */
      let publishing = false;

      async function publish() {
        if (publishing) return;
        publishing = true;

        postBtn.disabled = true; // üëà bloqueo inmediato

        try {
          const fd = new FormData();
          fd.append("content", content.value);
          fd.append("privacy", document.getElementById("privacy").value);

          const file = document.getElementById("file");
          if (file.files[0]) fd.append("file", file.files[0]);

          const res = await fetch(API + "/api/v1/posts", {
            method: "POST",
            headers: { Authorization: "Bearer " + token },
            body: fd,
          });

          if (!res.ok) {
            alert("Error al publicar");
            return;
          }

          content.value = "";
          removePreview();
          counter.innerText = "0 / 300";
          document.getElementById("privacy").value = "PUBLIC";

          await loadFeed();
        } finally {
          publishing = false;
        }
      }

      /* ---------- GLOBAL: cerrar men√∫s al clickear fuera (√∫nico listener) ---------- */
      document.addEventListener("click", () => {
        document
          .querySelectorAll(".options-menu, .profile-options-menu")
          .forEach((m) => {
            if (m) m.style.display = "none";
          });
      });

      /* ---------- LOAD FEED (usa estructura .tweet para compatibilidad visual) ---------- */
      async function loadFeed() {
        try {
          const r = await fetch(API + "/api/v1/posts/feed?page=0&size=10", {
            headers: { Authorization: "Bearer " + token },
          });
          const p = await r.json();
          feedEl.innerHTML = "";
          if (!p.content?.length) {
            feedEl.innerHTML = `<div class="empty">No hay posts</div>`;
            return;
          }

          for (const x of p.content) {
            // crear article con estructura "tweet"
            const post = document.createElement("article");
            post.className = "tweet";

            const timeRel = timeAgo(x.createdAt);
            const dateFull = new Date(x.createdAt).toLocaleString("es-AR", {
              dateStyle: "short",
              timeStyle: "short",
            });

            // privacy icon (only show icon if not PUBLIC)
            const privacyIcon = formatPrivacyIcon(x.privacy);
            const privacyHtml = privacyIcon
              ? `<span class="tweet-privacy-inline" title="${x.privacy}">${privacyIcon}</span>`
              : "";

            post.innerHTML = `
            <div class="tweet-clickable">  
              <div class="tweet-layout">
                  <div class="tweet-avatar"><img alt="avatar"></div>
                  
                    <div class="tweet-body">
                      <div class="tweet-header">
                        <div class="tweet-user user-text">
                          <span class="display-name">${
                            x.author.displayName
                          }</span>
                          <span class="username">@${x.author.username}</span>
                          <span class="dot">¬∑</span>
                          <span class="post-time" title="${dateFull}">${timeRel}</span>
                          ${privacyHtml}
                        </div>

                        <img src="icons/more.png" class="more-btn" alt="more">
                        <div class="options-menu"></div>
                      </div>

                      <div class="tweet-content user-text">${renderUserText(
                        x.content
                      )}</div>

                  

                  
                </div>
              </div>
            `;

            const clickable = post.querySelector(".tweet-clickable");

            clickable.addEventListener("click", () => {
              location.href = `post.html?id=${x.id}`;
            });

            // avatar
            const avImg = post.querySelector(".tweet-avatar img");
            loadAvatar(x.author.avatarUrl).then((a) => (avImg.src = a));
            // clicks to profile
            const nameEl = post.querySelector(".display-name");
            const userEl = post.querySelector(".username");
            avImg.onclick =
              nameEl.onclick =
              userEl.onclick =
                (e) => {
                  e.stopPropagation();
                  location.href = `user.html?username=${x.author.username}`;
                };

            // file image (if any)
            if (x.file) {
              const fileUrl = await (async () => {
                const i = await loadImg(x.file.url);
                return i;
              })();
              if (fileUrl) {
                const wrap = document.createElement("div");
                wrap.className = "tweet-image";

                const im = document.createElement("img");
                im.src = fileUrl;

                wrap.appendChild(im);

                wrap.addEventListener("click", (e) => {
                  e.stopPropagation();
                  openImage(fileUrl);
                });

                post.querySelector(".tweet-body").appendChild(wrap);
              }
            }
            const tweetUrlRaw = extractTweetUrl(x.content);
            const tweetUrl = tweetUrlRaw
              ? tweetUrlRaw.replace("x.com", "twitter.com")
              : null;
            const yt = extractYouTubeId(x.content);
            if (yt && !x.file) {
              post.querySelector(".tweet-body").innerHTML += `
                <div class="tweet-image">
                  <iframe
                    width="516"
                    height="290"
                    src="https://www.youtube.com/embed/${yt}"
                    frameborder="0"
                    allowfullscreen>
                  </iframe>
                </div>
              `;
            } else {
              if (tweetUrl && !x.file) {
                const wrap = document.createElement("div");
                wrap.className = "tweet-image";

                wrap.innerHTML = `
                <blockquote class="twitter-tweet">
                  <a href="${tweetUrl}"></a>
                </blockquote>
              `;

                post.querySelector(".tweet-body").appendChild(wrap);

                // asegurar render del embed
                const render = () => {
                  if (window.twttr && window.twttr.widgets) {
                    window.twttr.widgets.load(wrap);
                  }
                };

                if (!window.twttr) {
                  const s = document.createElement("script");
                  s.src = "https://platform.twitter.com/widgets.js";
                  s.async = true;
                  s.onload = render;
                  document.body.appendChild(s);
                } else {
                  render();
                }
              }
            }

            // menu handling
            const moreBtn = post.querySelector(".more-btn");
            const menu = post.querySelector(".options-menu");

            moreBtn.onclick = (e) => {
              e.stopPropagation();
              if (!menu) return;
              // hide others
              document
                .querySelectorAll(".options-menu, .profile-options-menu")
                .forEach((m) => {
                  if (m !== menu) m.style.display = "none";
                });
              menu.style.display =
                menu.style.display === "flex" ? "none" : "flex";
            };

            // delete option only for author
            if (x.author.username === username) {
              const del = document.createElement("div");
              del.className = "option delete-option";
              del.innerHTML = `<img src="icons/delete.png" alt="del"> Eliminar`;
              del.onclick = async () => {
                const res = await fetch(`${API}/api/v1/posts/${x.id}`, {
                  method: "DELETE",
                  headers: { Authorization: "Bearer " + token },
                });
                if (res.status === 204) post.remove();
                else alert("Error al eliminar el post");
              };
              if (menu) menu.appendChild(del);
            }

            const actions = document.createElement("div");
            actions.className = "tweet-actions";

            actions.innerHTML = `
                        <div class="tweet-action comment-action">
                          <img src="icons/comment.png">
                          <span class="comment-count">${x.commentCount}</span>
                        </div>

                        <div class="tweet-action like-action ${
                          x.liked ? "liked" : ""
                        }">
                          <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.7 4C18.87 4 21 6.98 21 9.76C21 15.39 12.16 20 12 20C11.84 20 3 15.39 3 9.76C3 6.98 5.13 4 8.3 4C10.12 4 11.31 4.91 12 5.71C12.69 4.91 13.88 4 15.7 4Z"
                              stroke="currentColor"
                              stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round"/>
                          </svg>
                          <span class="like-count">${x.likeCount}</span>
                        </div>
`;

            const commentAction = actions.querySelector(".comment-action");
            const likeAction = actions.querySelector(".like-action");
            const likeCountEl = actions.querySelector(".like-count");

            commentAction.addEventListener("click", (e) => {
              e.stopPropagation();
              location.href = `post.html?id=${x.id}`;
            });

            likeAction.addEventListener("click", async (e) => {
              e.stopPropagation();

              try {
                const res = await fetch(`${API}/api/v1/posts/${x.id}/like`, {
                  method: "POST",
                  headers: { Authorization: "Bearer " + token },
                });

                if (!res.ok) return;

                // optimistic update
                if (likeAction.classList.contains("liked")) {
                  likeAction.classList.remove("liked");
                  x.likeCount--;
                  x.liked = false;
                } else {
                  likeAction.classList.add("liked");
                  x.likeCount++;
                  x.liked = true;
                }

                likeCountEl.innerText = x.likeCount;
              } catch {
                console.error("Error toggling like");
              }
            });

            post.querySelector(".tweet-body").appendChild(actions);

            feedEl.appendChild(post);
          }
        } catch (e) {
          console.error("Error cargando feed", e);
          feedEl.innerHTML = `<div class="empty">Error al cargar posts</div>`;
        }
      }

      // inicializar
      loadFeed();

      // header scroll effect
      const header = document.querySelector("header");
      window.addEventListener("scroll", () => {
        if (window.scrollY > 5) header.classList.add("scrolled");
        else header.classList.remove("scrolled");
      });

      /* ---------- IMAGE LIGHTBOX ---------- */
      const imageOverlay = document.getElementById("imageOverlay");
      const overlayImg = document.getElementById("overlayImg");
      function openImage(src) {
        overlayImg.src = src;
        imageOverlay.style.display = "flex";
      }
      imageOverlay.addEventListener("click", (e) => {
        e.stopPropagation();
        imageOverlay.style.display = "none";
        overlayImg.src = "";
      });

      /*Color sidebar header banner*/
      function applyUserTheme(color) {
        const root = document.documentElement;

        if (color) {
          root.style.setProperty("--user-color", color);
          root.style.setProperty("--user-color-dark", darkenColor(color, 25));
        } else {
          root.style.setProperty("--user-color", "#1fe1d2");
          root.style.setProperty("--user-color-dark", "#3076e0");
        }
        document.body.classList.remove("theme-loading");
      }

      async function fetchMyProfile() {
        const r = await fetch(`${API}/api/v1/users/me`, {
          headers: { Authorization: "Bearer " + token },
        });

        if (!r.ok) throw new Error("No se pudo cargar el perfil");

        return r.json();
      }

      async function initUserTheme() {
        try {
          const u = await fetchMyProfile();
          applyUserTheme(u.bannerColor);
        } catch (e) {
          console.warn("Usando tema por defecto", e);
          applyUserTheme(null);
        }
      }
      function darkenColor(hex, percent) {
        const num = parseInt(hex.replace("#", ""), 16);
        const amt = Math.round(2.55 * percent);
        const r = Math.max(0, (num >> 16) - amt);
        const g = Math.max(0, ((num >> 8) & 0x00ff) - amt);
        const b = Math.max(0, (num & 0x0000ff) - amt);

        return `rgb(${r}, ${g}, ${b})`;
      }
      initUserTheme();
    </script>
  </body>
</html>
